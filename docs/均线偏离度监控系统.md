# 均线偏离度监控预警系统

## 概述

均线偏离度监控系统用于实时监控主要指数价格相对均线的偏离程度，当偏离超过阈值时发出预警，帮助投资者识别市场极端情况和潜在的回调/反弹机会。

## 功能特性

### 1. 多指数监控

**A股指数**（9个）：
- 上证指数 (sh000001)
- 沪深300 (sh000300)
- 创业板指 (sz399006)
- 科创50 (sh000688)
- 深证成指 (sz399001)
- 中小板指 (sz399005)
- 上证50 (sh000016)
- 中证500 (sh000905)
- 中证1000 (sh000852)

**港股指数**（2个）：
- 恒生指数 (HSI)
- 恒生科技 (HSTECH)

### 2. 三级预警机制

| 预警级别 | 偏离阈值 | 说明 |
|---------|---------|------|
| ⚠️ 一级预警 | >20% | 价格偏离较大，需要关注 |
| 🚨 二级预警 | >30% | 极端偏离，历史上往往伴随回调或反弹 |
| 💥 三级预警 | >40% | 罕见极端情况，高度警惕 |

### 3. 监控维度

- **MA20 偏离度**：短期趋势
- **MA60 偏离度**：中期趋势
- **MA120 偏离度**：长期趋势

### 4. 历史统计分析

- 历史偏离事件统计
- 偏离后未来表现分析（5日、10日、20日、60日）
- 上涨概率和平均收益率

## 使用方法

### 快速运行

```bash
# 控制台输出监控结果
python scripts/position_analysis/run_ma_deviation_monitor.py

# 发送邮件通知
python scripts/position_analysis/run_ma_deviation_monitor.py --email

# 自定义重试次数
python scripts/position_analysis/run_ma_deviation_monitor.py --email --retry 5

# 静默模式(仅发送邮件,不输出到控制台)
python scripts/position_analysis/run_ma_deviation_monitor.py --email --quiet
```

### 邮件通知配置

1. **复制配置模板**:
```bash
cp email_config.yaml.template email_config.yaml
```

2. **填写邮箱信息**:
```yaml
smtp:
  server: smtp.qq.com        # SMTP服务器
  port: 465                  # SMTP端口

sender:
  email: your_email@qq.com        # 发件邮箱
  password: your_app_password     # 邮箱授权码
  name: 股票监控系统

recipients:
  - your_email@qq.com             # 收件人
```

**获取邮箱授权码**:
- **QQ邮箱**: 邮箱设置 → 账户 → POP3/IMAP/SMTP → 生成授权码
- **163邮箱**: 邮箱设置 → POP3/SMTP/IMAP → 开启服务并获取授权码

3. **测试邮件发送**:
```bash
python scripts/position_analysis/run_ma_deviation_monitor.py --email
```

### 定时任务配置

详见 [定时任务配置指南](./定时任务配置指南.md)

**快速配置 (macOS/Linux)**:

```bash
# 1. 创建监控脚本
cat > ~/bin/stock_monitor.sh << 'EOF'
#!/bin/bash
cd /Users/russ/PycharmProjects/stock-analysis
python3 scripts/position_analysis/run_ma_deviation_monitor.py --email --quiet
EOF

chmod +x ~/bin/stock_monitor.sh

# 2. 配置 cron (每天15:10执行)
crontab -e
# 添加: 10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

### 程序化调用

```python
from position_analysis.ma_deviation_monitor import MADeviationMonitor

# 初始化监控器
monitor = MADeviationMonitor()

# 监控所有指数
all_alerts = monitor.monitor_all_indices()

# 生成报告
report = monitor.generate_alert_report(all_alerts)
print(report)

# 分析单个指数
alerts = monitor.check_deviation_alerts('sh000688')  # 科创50
for alert in alerts:
    print(f"{alert.alert_level}: {alert.message}")

# 历史表现分析
performance = monitor.analyze_post_deviation_performance(
    'sh000688',
    ma_period=60,
    threshold=30.0
)
```

## 输出示例

### 预警报告

```
======================================================================
🚨 均线偏离度预警报告
生成时间: 2025-10-10 22:41:59
======================================================================

📊 预警总览:
  - 触发预警指数: 4 个
  - 预警信号总数: 5 个
  - 三级预警(>40%): 0 个
  - 二级预警(>30%): 2 个

📋 详细预警信息:

【创业板指】
  ⚠️  二级预警 | 创业板指 大幅上涨！当前价格 3113.26，偏离120日均线 31.9%

【科创50】
  ⚠️  一级预警 | 科创50 大幅上涨！当前价格 1452.67，偏离60日均线 20.6%
  🚨 二级预警 | 科创50 大幅上涨！当前价格 1452.67，偏离120日均线 32.2%
```

### 历史分析

```
【科创50】
  近1000天内偏离60日均线>30%事件: 13 次
  最近一次: 2025-08-28

  📊 向上偏离>30%后的历史表现 (样本: 16 次):
     5d: 平均收益 -6.86%, 上涨概率 6.2%
    10d: 平均收益 -3.76%, 上涨概率37.5%
    20d: 平均收益 -1.72%, 上涨概率43.8%
    60d: 平均收益 -4.37%, 上涨概率 0.0%
```

## 核心API

### MADeviationMonitor 类

#### calculate_ma_deviation()
计算指数的均线偏离度

**参数**：
- `index_code`: 指数代码
- `ma_periods`: 均线周期列表，默认 [20, 60, 120]

**返回**：
```python
{
    'index_name': '科创50',
    'current_price': 1452.67,
    'date': '2025-10-10',
    'deviations': {
        'ma60': {
            'ma_value': 1204.32,
            'deviation_pct': 20.6,
            'direction': '向上偏离',
            'abs_deviation': 20.6
        }
    }
}
```

#### check_deviation_alerts()
检查偏离度预警

**返回**：`List[DeviationAlert]`

#### get_historical_deviation_events()
获取历史偏离事件

**参数**：
- `index_code`: 指数代码
- `ma_period`: 均线周期
- `threshold`: 偏离阈值
- `lookback_days`: 回溯天数

**返回**：历史偏离事件 DataFrame

#### analyze_post_deviation_performance()
分析偏离事件后的表现

**参数**：
- `index_code`: 指数代码
- `ma_period`: 均线周期
- `threshold`: 偏离阈值
- `forward_days`: 未来观察周期

**返回**：表现统计字典

## 实战应用

### 1. 日常监控

建议每日收盘后运行监控脚本，识别极端偏离的指数。

### 2. 回调预警

当指数**向上偏离**超过30%时：
- 历史数据显示短期回调概率较高
- 建议控制仓位，警惕获利回吐
- 关注成交量是否配合

### 3. 抄底信号

当指数**向下偏离**超过30%时：
- 历史数据显示反弹概率较高
- 可关注超跌反弹机会
- 结合估值、资金流向综合判断

### 4. 策略回测

可以基于历史偏离事件构建交易策略：
```python
# 示例：偏离30%后的反转策略
performance = monitor.analyze_post_deviation_performance(
    'sh000001',  # 上证指数
    ma_period=60,
    threshold=30.0
)

# 查看向下偏离后的反弹表现
downward_perf = performance['downward_performance']
print(f"20日后平均收益: {downward_perf['20d']['mean_return']:.2f}%")
print(f"上涨概率: {downward_perf['20d']['positive_ratio']:.1%}")
```

## 历史规律总结

基于近1000天的历史数据分析：

### 向上大幅偏离（>30%）
- **短期（5-10日）**：震荡或小幅回调，上涨概率 40-60%
- **中期（20日）**：回调概率增加，平均收益转负
- **长期（60日）**：大幅回调风险高，需警惕泡沫

### 向下大幅偏离（>30%）
- **短期（5-10日）**：反弹概率较高，60-80%
- **中期（20日）**：反弹延续，平均收益10-20%
- **长期（60日）**：强势反弹，历史平均收益>30%

## 注意事项

1. **偏离度仅为参考指标**：需结合估值、资金流向、市场情绪等多维度判断
2. **不同指数特性不同**：科创50波动性大，偏离事件更频繁；上证指数相对稳定
3. **历史不代表未来**：统计规律仅供参考，不作为投资决策的唯一依据
4. **极端市场环境**：牛熊转折期间，偏离度可能长时间维持在高位
5. **港股数据获取**：港股数据可能因网络问题导致获取失败，需重试

## 技术实现

### 偏离度计算公式

```python
deviation_pct = (current_price - ma_value) / ma_value * 100
```

### 预警判断逻辑

```python
if abs(deviation_pct) >= 40:
    alert_level = '三级预警'
elif abs(deviation_pct) >= 30:
    alert_level = '二级预警'
elif abs(deviation_pct) >= 20:
    alert_level = '一级预警'
```

### 数据来源

- **A股数据**：AKShare `stock_zh_index_daily()`
- **港股数据**：AKShare `stock_hk_index_daily_em()`

## 相关文档

- [历史点位对比分析功能](./历史点位对比分析功能设计.md)
- [Position Analysis README](../position_analysis/README.md)

## 版本历史

- **v1.1** (2025-10-10)：添加邮件通知、失败重试、定时任务支持
- **v1.0** (2025-10-10)：初始版本，支持11个主要指数监控，三级预警机制，历史统计分析

## 已实现功能

- [x] 11个主要指数监控 (9个A股 + 2个港股)
- [x] 三级预警机制 (20%/30%/40%)
- [x] 历史偏离事件统计分析
- [x] 邮件通知功能
- [x] 失败自动重试 (最多3次)
- [x] 定时任务支持 (cron/launchd)
- [x] HTML格式邮件报告
- [x] 预警级别优先级标识

## 未来计划

- [ ] 添加企业微信/钉钉推送
- [ ] 支持自定义指数和阈值配置
- [ ] 增加技术指标组合预警（偏离度 + RSI + MACD）
- [ ] Web可视化界面
