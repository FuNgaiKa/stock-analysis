# 量价关系分析学习指南

> 本文档沉淀了 `russ_trading` 模块中量价关系增强分析功能的实现原理和使用方法，帮助理解量能分析在投研复盘中的应用。

---

## 📚 目录

1. [功能概述](#功能概述)
2. [核心概念](#核心概念)
3. [实现详解](#实现详解)
4. [实战应用](#实战应用)
5. [报告解读](#报告解读)
6. [策略建议](#策略建议)

---

## 功能概述

### 新增功能模块

本次更新在 `VolumePriceAnalyzer` 中新增了以下6个核心分析维度：

| 功能 | 方法 | 价值 |
|------|------|------|
| 量价配合分析 | `analyze_cooperation()` | 验证趋势有效性 |
| 量价背离检测 | `detect_divergence()` | 预警趋势反转 |
| OBV背离分析 | `detect_obv_divergence()` | 资金持续流向分析 |
| 换手率分析 | `get_turnover_rate()` | 评估交易活跃度 |
| 量比计算 | `analyze_turnover_and_volume_ratio()` | 识别异常交易日 |
| 突破确认 | `analyze_volume_breakout()` | 判断突破有效性 |

### 文件位置

- **核心代码**: `russ_trading/analyzers/volume_price_analyzer.py`
- **报告集成**: `scripts/analysis/comprehensive_asset_analysis/asset_reporter.py`
- **运行入口**: `russ_trading/runners/run_unified_analysis.py`

---

## 核心概念

### 1. 量价配合 (Volume-Price Cooperation)

**原理**: 健康的上涨应该伴随成交量放大，健康的下跌应该伴随成交量萎缩。

**四种量价关系**:

| 关系 | 价格 | 成交量 | 含义 | 评分 |
|------|------|--------|------|------|
| 价涨量增 | ↑ | ↑ | 健康上涨，资金认可 | +10 |
| 价涨量缩 | ↑ | ↓ | 上涨乏力，动能衰竭 | -5 |
| 价跌量增 | ↓ | ↑ | 恐慌抛售，加速下跌 | -10 |
| 价跌量缩 | ↓ | ↓ | 抛压减轻，可能企稳 | +5 |

**判断标准**:
- **量价齐升**: 过去5天中，价涨量增≥60% → 优秀
- **量价背离**: 过去5天中，价涨量缩≥50% → 偏弱
- **量价齐跌**: 过去5天中，价跌量增≥50% → 极弱
- **缩量筑底**: 过去5天中，价跌量缩≥50% → 偏强

**量价协同度**: 0-100分，计算公式：`50 + 各日评分之和`

---

### 2. 量价背离 (Volume-Price Divergence)

**原理**: 当价格和成交量走势出现分歧时，预示趋势可能反转。

#### 顶背离 (看跌信号)
- **条件**: 价格创新高，但成交量未创新高
- **含义**: 主力出货，上涨动能不足
- **操作**: 减仓或止盈

```
价格: 100 → 110 → 120 (新高)
成交量: 1000万 → 800万 → 600万 (递减)
结论: 顶背离，警惕回调
```

#### 底背离 (看涨信号)
- **条件**: 价格创新低，但成交量未创新低
- **含义**: 抛压减轻，可能见底
- **操作**: 关注反弹机会

```
价格: 100 → 90 → 80 (新低)
成交量: 1000万 → 800万 → 900万 (不再新低)
结论: 底背离，关注反弹
```

---

### 3. OBV 能量潮 (On Balance Volume)

**原理**: 累积成交量，反映资金的持续流向。

**计算方法**:
```python
if 今日收盘价 > 昨日收盘价:
    OBV = 昨日OBV + 今日成交量
elif 今日收盘价 < 昨日收盘价:
    OBV = 昨日OBV - 今日成交量
else:
    OBV = 昨日OBV
```

**OBV趋势判断**:
- OBV > 10日均值 × 1.05 → 上升趋势
- OBV < 10日均值 × 0.95 → 下降趋势
- 其他 → 平稳

**OBV背离**:
- **顶背离**: 价格新高，OBV未新高 → 看跌
- **底背离**: 价格新低，OBV未新低 → 看涨

---

### 4. 换手率 (Turnover Rate)

**定义**: 当日成交量 / 流通股本

**级别划分**:

| 换手率 | 级别 | 含义 |
|--------|------|------|
| ≥10% | 极高 | 分歧极大，可能变盘 |
| 5%-10% | 高 | 交易活跃，关注方向 |
| 2%-5% | 中等 | 正常交易 |
| 1%-2% | 偏低 | 关注度下降 |
| <1% | 低 | 筹码锁定或缺乏关注 |

**注意**: 换手率仅支持A股，通过 `akshare` 实时获取。

---

### 5. 量比 (Volume Ratio)

**定义**: 今日成交量 / 过去5日平均成交量

**级别划分**:

| 量比 | 级别 | 含义 |
|------|------|------|
| ≥3.0 | 巨量 | 极端异常，重大事件 |
| 2.0-3.0 | 显著放量 | 明显异动，关注原因 |
| 1.5-2.0 | 放量 | 成交活跃 |
| 0.8-1.5 | 正常 | 正常交易 |
| 0.5-0.8 | 缩量 | 观望情绪 |
| <0.5 | 极度缩量 | 无人关注或节假日前 |

---

### 6. 成交量突破确认 (Volume Breakout Confirmation)

**原理**: 价格突破关键位时，验证成交量是否配合。

**核心逻辑**:
```
有效突破 = 价格突破阻力位 + 成交量放大1.5倍以上
假突破 = 价格突破但量能不足 → 高概率回落
```

**四种状态**:

| 状态 | 条件 | 信号 |
|------|------|------|
| 有效突破 | 价格>阻力位 & 量比≥1.5 | 买入信号 |
| 假突破风险 | 价格>阻力位 & 量比<1.5 | 观望 |
| 蓄势待发 | 价格<阻力位 & 量比≥2.0 | 关注 |
| 未突破 | 价格<阻力位 & 量比<2.0 | 观望 |

---

## 实现详解

### 代码架构

```
russ_trading/analyzers/volume_price_analyzer.py
├── VolumePriceAnalyzer (类)
│   ├── detect_obv_divergence()      # OBV背离检测
│   ├── get_turnover_rate()          # 获取A股换手率
│   ├── analyze_turnover_and_volume_ratio()  # 换手率和量比分析
│   ├── analyze_volume_breakout()    # 成交量突破确认
│   ├── analyze_volume_price_relationship()  # 完整量价分析
│   ├── analyze_cooperation()        # 量价配合分析
│   ├── detect_divergence()          # 量价背离检测
│   ├── analyze_volume_features()    # 成交量特征分析
│   ├── _find_peaks()                # 寻找峰值点
│   ├── _find_troughs()              # 寻找谷值点
│   ├── _calculate_vp_score()        # 计算量价评分
│   └── _generate_vp_signal()        # 生成操作信号
```

### 量价评分算法

**评分范围**: 0-100分

**评分组成**:
1. **量价协同度** (50%权重): 协同度分数 × 0.5
2. **背离检测** (±20分):
   - 无背离: +20分
   - 底背离: +10分
   - 顶背离: -20分
3. **成交量配合** (±10分):
   - 放量上涨: +10分
   - 放量下跌: -10分

**信号对照**:

| 评分 | 信号 | 建议 |
|------|------|------|
| ≥80 | 强烈买入 | 量价配合极佳，可积极配置 |
| 65-79 | 买入 | 量价配合良好，可正常配置 |
| 50-64 | 中性偏多 | 量价关系尚可，可小仓位参与 |
| 35-49 | 观望 | 量价配合一般，建议观望为主 |
| 20-34 | 减仓 | 量价背离，上涨乏力，建议减仓 |
| <20 | 清仓 | 量价严重背离，建议清仓规避 |

### 峰值/谷值检测算法

采用邻域比较法，默认邻域大小为3：

```python
def _find_peaks(self, data, order=3):
    peaks = []
    for i in range(order, len(data) - order):
        # 当前点大于左侧order个点，也大于右侧order个点
        if all(data[i] > data[i-j] for j in range(1, order+1)) and \
           all(data[i] > data[i+j] for j in range(1, order+1)):
            peaks.append(i)
    return peaks
```

---

## 实战应用

### 使用方式

#### 1. 生成每日报告

```bash
python -m russ_trading.runners.run_unified_analysis --email
```

报告中会自动包含"量能分析"章节。

#### 2. 单独调用分析器

```python
from russ_trading.analyzers.volume_price_analyzer import VolumePriceAnalyzer
import yfinance as yf

# 获取数据
ticker = yf.Ticker("512880.SS")
df = ticker.history(period="1y")
df.columns = df.columns.str.lower()

# 创建分析器
analyzer = VolumePriceAnalyzer()

# 完整量价分析
result = analyzer.analyze_volume_price_relationship(df, lookback=20)
print(f"量价评分: {result['vp_score']}/100")
print(f"操作信号: {result['signal']}")
print(f"分析描述: {result['description']}")

# OBV背离检测
obv_result = analyzer.detect_obv_divergence(df, lookback=20)
print(f"OBV趋势: {obv_result['obv_trend']}")
print(f"OBV背离: {obv_result['divergence_desc']}")

# 换手率和量比分析 (仅A股)
turnover_result = analyzer.analyze_turnover_and_volume_ratio(df, symbol='512880')
print(f"换手率: {turnover_result['turnover_rate']*100:.1f}%")
print(f"量比: {turnover_result['volume_ratio']:.2f}")

# 成交量突破确认
breakout_result = analyzer.analyze_volume_breakout(df, lookback=20)
print(f"突破状态: {breakout_result['status']}")
print(f"阻力位: {breakout_result['resistance_price']:.2f}")
```

### 应用场景

#### 场景1: 验证趋势健康度

**需求**: 持仓标的连续上涨，判断是否继续持有

**分析步骤**:
1. 检查量价配合状态 → 价涨量增 = 健康
2. 检查量价背离 → 无顶背离 = 安全
3. 检查OBV趋势 → 上升 = 资金持续流入

**示例**:
```
量价配合: ✅ 量价齐升 (协同度: 75/100)
量价背离: 无
OBV趋势: 上升
结论: 趋势健康，继续持有
```

#### 场景2: 判断突破有效性

**需求**: 标的价格突破前高，判断是否跟进

**分析步骤**:
1. 检查突破确认 → 有效突破/假突破风险
2. 检查量比 → ≥1.5为有效

**示例**:
```
突破确认: ✅ 有效突破
阻力位: 1.25, 量比: 1.8, 信号: 买入信号
结论: 放量突破，可跟进
```

#### 场景3: 识别底部机会

**需求**: 标的连续下跌，判断是否见底

**分析步骤**:
1. 检查量价配合 → 缩量筑底 = 抛压减轻
2. 检查底背离 → 有底背离 = 可能反弹
3. 检查OBV背离 → 底背离 = 资金托底

**示例**:
```
量价配合: 缩量筑底 (协同度: 60/100)
量价背离: ✅ 底背离 (价格新低但成交量未新低)
OBV背离: ✅ 底背离看涨
结论: 可能见底，关注反弹机会
```

---

## 报告解读

### 报告中的量能分析章节

生成的市场洞察报告中，每个标的会显示以下信息：

```markdown
### 量能分析

- **量价配合**: ✅ 量价齐升 (协同度: 75/100)
- **量价背离**: 无
- **换手率**: 2.3% (中等)
- **量比**: 1.45 📈 (放量)
- **OBV趋势**: 上升 📈
- **突破确认**: ✅ 有效突破
  - 阻力位: 1.25, 量比: 1.8, 信号: 买入信号
- **量能信号**: 买入 - 量价配合良好,价涨量增,可正常配置
```

### 图标含义

| 图标 | 含义 |
|------|------|
| ✅ | 正向信号 (健康/有效/看涨) |
| ⚠️ | 警告信号 (背离/风险) |
| 📈 | 上升/放量 |
| 📉 | 下降/缩量 |
| ➡️ | 平稳/正常 |

---

## 策略建议

### 结合超激进策略的应用

根据你的Ultra Aggressive策略（目标2026年翻倍+），量能分析的应用建议：

#### 1. 进场信号增强

**强买入条件**:
- 量价评分 ≥ 80
- 量比 ≥ 1.5 (放量)
- 无顶背离
- OBV趋势上升

**示例**: 当证券ETF满足以上条件时，可加大仓位至上限30%

#### 2. 减仓信号确认

**减仓信号**:
- 量价评分 < 35
- 出现顶背离
- OBV趋势下降
- 突破确认为"假突破风险"

**示例**: 当恒生科技出现顶背离 + OBV下降时，考虑减仓5-10%

#### 3. 止损信号强化

结合动态止损功能，量能分析可提供额外确认：
- 如果触发动态止损线 + 量价评分 < 20 → 坚决止损
- 如果触发动态止损线但量价评分 > 50 → 可等待确认

#### 4. 波段操作优化

**高抛信号**:
- 量比 ≥ 2.0 (显著放量)
- 换手率 ≥ 5% (高换手)
- 出现顶背离

**低吸信号**:
- 量比 < 0.5 (极度缩量)
- 出现底背离
- 量价配合为"缩量筑底"

### 与其他分析维度的协同

量能分析应与其他分析维度配合使用，提高信号准确度：

| 量能信号 | 技术信号 | 资金流 | 综合判断 |
|----------|----------|--------|----------|
| 放量上涨 | MACD金叉 | 主力净流入 | 强买入 ✅✅✅ |
| 放量上涨 | MACD金叉 | 主力净流出 | 谨慎买入 ⚠️ |
| 缩量上涨 | RSI超买 | 主力净流出 | 减仓 ⚠️⚠️ |
| 放量下跌 | MACD死叉 | 主力净流出 | 止损 🔴🔴🔴 |

---

## 参考资料

### 学术/经典

1. **Granville, J.E.** - "Granville's New Strategy of Daily Stock Market Timing for Maximum Profit" (1976)
   - OBV (On Balance Volume) 的发明者

2. **Murphy, J.J.** - "Technical Analysis of the Financial Markets" (1999)
   - 量价关系的经典教材

### 代码位置

- 核心分析器: `russ_trading/analyzers/volume_price_analyzer.py`
- 报告生成: `scripts/analysis/comprehensive_asset_analysis/asset_reporter.py`
- 运行入口: `russ_trading/runners/run_unified_analysis.py`

### 相关文档

- 投资策略: `docs/2026翻倍激进方案.md`
- 风险管理: `docs/机构级风险管理方法论.md`
- 动态止损: `docs/动态止损功能说明.md` (如有)

---

## 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2025-11-20 | v1.1 | 新增成交量突破确认分析策略 |
| 2025-11-20 | v1.0 | 新增量价配合/换手率/量比/OBV背离分析 |

---

**文档维护**: Claude Code
**最后更新**: 2025-11-20
