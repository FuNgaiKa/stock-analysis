# 市场分析指标增强说明

## 更新时间
2025-10-13

## 概述

本次更新为所有市场分析器(A股、港股、美股)添加了3类关键风险和收益指标,提升了分析的全面性和实用性。

## 新增指标详解

### 1. 胜率与盈亏比 (Win Rate & Profit/Loss Ratio)

**指标定义:**
- **胜率 (win_rate)**: 在所有相似时期中,未来上涨的次数占比
- **平均盈利 (avg_win)**: 上涨时的平均收益率
- **平均亏损 (avg_loss)**: 下跌时的平均亏损率
- **盈亏比 (profit_loss_ratio)**: 平均盈利 / |平均亏损|

**作用:**
- 评估策略质量的核心指标
- 盈亏比 > 1 表示赚的比亏的多,策略更优
- 结合胜率和盈亏比,可以判断策略是"高胜率低盈亏比"还是"低胜率高盈亏比"

**实例解读:**

```
创业板指 (2025-10-13):
  胜率: 63.6%
  平均盈利: +4.60%
  平均亏损: -8.73%
  盈亏比: 0.53
```

**分析**: 虽然胜率较高(63.6%),但盈亏比偏低(0.53),说明盈利时赚得少,亏损时亏得多。这是典型的"高胜率低盈亏比"模式,风险较大。

```
标普500 (2025-10-13):
  胜率: 96.1%
  平均盈利: +2.37%
  平均亏损: -0.57%
  盈亏比: 4.16
```

**分析**: 胜率极高(96.1%),且盈亏比优秀(4.16),说明这是低风险高回报的点位,属于优质买入机会。

---

### 2. 波动率 (Volatility)

**指标定义:**
- **年化波动率 (volatility)**: 收益率的标准差年化值
- 计算公式: `std(returns) * sqrt(252)`

**作用:**
- 衡量资产价格波动的剧烈程度
- 波动率越高,风险越大,但潜在收益也可能更高
- 影响Kelly公式的仓位计算(波动率高会降低建议仓位)

**参考标准:**
- 低波动: < 15% (如债券、稳健型股票)
- 中波动: 15%-30% (如大盘股、成熟市场)
- 高波动: 30%-60% (如小盘股、新兴市场)
- 极高波动: > 60% (如加密货币、创业板)

**实例解读:**

```
标普500: 18.19% - 低波动,风险可控
恒生指数: 80.90% - 高波动,波动较大
创业板指: 116.33% - 极高波动,风险极大
```

---

### 3. 最大回撤 (Maximum Drawdown)

**指标定义:**
- **最大回撤 (max_dd)**: 在持仓期间,从最高点到最低点的最大跌幅
- **平均回撤 (avg_dd)**: 所有相似时期的平均回撤
- **回撤>5%概率 (dd_prob)**: 回撤超过5%的历史概率
- **回撤标准差 (dd_std)**: 回撤的波动程度

**作用:**
- 评估风险的最直观指标
- 帮助投资者了解"最坏情况下会亏多少"
- 影响仓位决策(回撤大需要降低仓位)

**实例解读:**

```
标普500 (2025-10-13):
  最大回撤: -3.06%
  平均回撤: -1.78%
  回撤>5%概率: 0.0%
```

**分析**: 风险极低,历史上从未出现过超过5%的回撤,适合配置较高仓位。

```
创业板指 (2025-10-13):
  最大回撤: -24.43%
  平均回撤: -7.90%
  回撤>5%概率: 71.0%
```

**分析**: 风险极高,最大可能亏损24.43%,71%的情况下会回撤超过5%,需要严格控制仓位。

---

## 测试结果对比

### A股 - 创业板指 (CYBZ)

| 指标类别 | 指标名称 | 数值 | 评价 |
|---------|---------|------|------|
| **基础指标** | 当前点位 | 3113.26 | - |
| | 相似时期 | 122个 | 样本充足 |
| | 20日上涨概率 | 63.6% | 中性偏多 |
| | 平均收益率 | -0.26% | 接近平衡 |
| **胜率盈亏比** | 胜率 | 63.6% | 较高 |
| | 平均盈利 | +4.60% | 一般 |
| | 平均亏损 | -8.73% | 较大 |
| | 盈亏比 | 0.53 | 偏低 ⚠️ |
| **风险指标** | 波动率 | 116.33% | 极高 ⚠️ |
| | 最大回撤 | -24.43% | 极大 ⚠️ |
| | 平均回撤 | -7.90% | 较大 |
| | 回撤>5%概率 | 71.0% | 很高 ⚠️ |

**综合评价**: 虽然胜率较高,但盈亏比低、波动大、回撤风险高,属于高风险资产,建议控制仓位。

---

### 港股 - 恒生指数 (HSI)

| 指标类别 | 指标名称 | 数值 | 评价 |
|---------|---------|------|------|
| **基础指标** | 当前点位 | 26290.32 | - |
| | 相似时期 | 156个 | 样本充足 |
| | 20日上涨概率 | 45.0% | 中性偏空 |
| | 平均收益率 | +0.22% | 微正 |
| **胜率盈亏比** | 胜率 | 45.0% | 偏低 |
| | 平均盈利 | +4.72% | 一般 |
| | 平均亏损 | -3.47% | 可控 |
| | 盈亏比 | 1.36 | 良好 ✅ |
| **风险指标** | 波动率 | 80.90% | 高 |
| | 最大回撤 | -10.75% | 中等 |
| | 平均回撤 | -5.05% | 中等 |
| | 回撤>5%概率 | 45.7% | 中等 |

**综合评价**: 胜率不高但盈亏比好,属于"低胜率高盈亏比"策略,风险中等,可配置标准仓位。

---

### 美股 - 标普500 (SPX)

| 指标类别 | 指标名称 | 数值 | 评价 |
|---------|---------|------|------|
| **基础指标** | 当前点位 | 6552.51 | - |
| | 相似时期 | 66个 | 样本充足 |
| | 20日上涨概率 | 96.1% | 极高 ✅ |
| | 平均收益率 | +2.26% | 良好 ✅ |
| **胜率盈亏比** | 胜率 | 96.1% | 极高 ✅ |
| | 平均盈利 | +2.37% | 一般 |
| | 平均亏损 | -0.57% | 极小 ✅ |
| | 盈亏比 | 4.16 | 优秀 ✅ |
| **风险指标** | 波动率 | 18.19% | 低 ✅ |
| | 最大回撤 | -3.06% | 极小 ✅ |
| | 平均回撤 | -1.78% | 极小 ✅ |
| | 回撤>5%概率 | 0.0% | 极低 ✅ |

**综合评价**: 完美的低风险高回报配置,胜率极高、盈亏比优秀、风险极低,属于罕见的优质买入机会。

---

## 如何使用这些指标

### 1. 评估策略质量

**高质量策略特征:**
- 胜率 > 60% 或 盈亏比 > 2
- 至少满足一项,最好两项都满足
- 例: 标普500 (胜率96.1% + 盈亏比4.16) ✅

**低质量策略特征:**
- 胜率 < 50% 且 盈亏比 < 1
- 两项都不达标,风险较高
- 例: 如果胜率40% + 盈亏比0.8 ⚠️

### 2. 调整仓位大小

**Kelly公式已自动考虑:**
- 波动率高 → 降低仓位
- 盈亏比低 → 降低仓位
- 最大回撤大 → 降低仓位

**手动调整参考:**
```
最大回撤 < 5%  → 可配置高仓位(70-90%)
最大回撤 5-10% → 标准仓位(50-70%)
最大回撤 10-20% → 低仓位(30-50%)
最大回撤 > 20%  → 极低仓位(10-30%)
```

### 3. 风险预警

**关注以下组合:**
- ⚠️ 高波动 + 大回撤 + 低盈亏比 → 高风险,谨慎操作
  - 例: 创业板指 (波动116% + 回撤24% + 盈亏比0.53)

- ✅ 低波动 + 小回撤 + 高盈亏比 → 低风险,可积极配置
  - 例: 标普500 (波动18% + 回撤3% + 盈亏比4.16)

---

## 代码实现

### 新增方法

所有市场分析器都新增了以下方法:

```python
def calculate_max_drawdown(self, index_code: str, similar_periods: pd.DataFrame, period: int = 20) -> Dict:
    """计算相似时期的最大回撤统计"""
    # 返回: max_dd, avg_dd, dd_prob, dd_std

def calculate_probability_statistics(self, returns: pd.Series) -> Dict:
    """计算涨跌概率及统计指标"""
    # 原有指标 + 新增: win_rate, avg_win, avg_loss, profit_loss_ratio, volatility
```

### 使用示例

```python
from position_analysis.cn_market_analyzer import CNMarketAnalyzer

analyzer = CNMarketAnalyzer()
result = analyzer.analyze_single_index('CYBZ', tolerance=0.05)

# 获取20日周期的指标
stats = result['period_analysis']['20d']

# 访问新增指标
print(f"胜率: {stats['win_rate']:.1%}")
print(f"盈亏比: {stats['profit_loss_ratio']:.2f}")
print(f"波动率: {stats['volatility']:.2%}")
print(f"最大回撤: {stats['max_dd']:.2%}")
print(f"平均回撤: {stats['avg_dd']:.2%}")
print(f"回撤>5%概率: {stats['dd_prob']:.1%}")
```

---

## 相关文件

- `/position_analysis/cn_market_analyzer.py` - A股分析器 (已更新)
- `/position_analysis/hk_market_analyzer.py` - 港股分析器 (已更新)
- `/position_analysis/us_market_analyzer.py` - 美股分析器 (已更新)

---

## 向后兼容

- 所有新增指标都是额外添加,不影响现有指标
- API接口保持不变
- 旧代码无需修改即可继续使用

---

## 未来规划

后续可考虑添加的指标(优先级2):
1. MACD金叉/死叉
2. 连续涨跌天数
3. 成交量变化率

---

## 更新历史

- **2025-10-13**: 为所有市场分析器添加胜率/盈亏比、波动率、最大回撤指标
- **2025-10-13**: 完成测试验证,所有市场运行正常
