# 定时任务配置指南

本文档介绍如何在本地配置定时任务,实现每日自动监控均线偏离度并发送邮件通知。

## 前置准备

### 1. 配置邮箱

复制邮箱配置模板并填写信息:

```bash
cd /Users/russ/PycharmProjects/stock-analysis
cp email_config.yaml.template email_config.yaml
```

编辑 `email_config.yaml`,填写以下信息:

```yaml
smtp:
  server: smtp.qq.com      # 你的邮箱SMTP服务器
  port: 465                # SMTP端口

sender:
  email: your_email@qq.com        # 发件邮箱
  password: your_app_password     # 邮箱授权码(不是登录密码!)
  name: 股票监控系统               # 发件人名称

recipients:
  - your_email@qq.com             # 收件邮箱(可以多个)
```

**重要**:
- `password` 是邮箱的**授权码**,不是登录密码
- QQ邮箱授权码获取: 邮箱设置 → 账户 → POP3/IMAP/SMTP → 生成授权码
- 163邮箱授权码获取: 邮箱设置 → POP3/SMTP/IMAP → 开启服务并获取授权码

### 2. 测试邮件发送

运行以下命令测试邮件发送功能:

```bash
python scripts/position_analysis/run_ma_deviation_monitor.py --email
```

如果配置正确,你将收到一封预警邮件。

## macOS 定时任务配置

macOS 推荐使用 cron 或 launchd 实现定时任务。

### 方案一: 使用 cron (推荐)

#### 1. 创建监控脚本

创建一个 shell 脚本方便 cron 调用:

```bash
# 创建脚本目录
mkdir -p ~/bin

# 创建监控脚本
cat > ~/bin/stock_monitor.sh << 'EOF'
#!/bin/bash

# 项目路径
PROJECT_DIR="/Users/russ/PycharmProjects/stock-analysis"

# Python 环境(根据你的实际情况修改)
PYTHON="/usr/bin/python3"

# 日志文件
LOG_DIR="$PROJECT_DIR/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/ma_deviation_$(date +\%Y\%m\%d).log"

# 运行监控并记录日志
echo "========================================" >> "$LOG_FILE"
echo "开始监控: $(date)" >> "$LOG_FILE"
echo "========================================" >> "$LOG_FILE"

cd "$PROJECT_DIR"
$PYTHON scripts/position_analysis/run_ma_deviation_monitor.py --email --quiet >> "$LOG_FILE" 2>&1

EXIT_CODE=$?

echo "结束监控: $(date), 退出码: $EXIT_CODE" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

exit $EXIT_CODE
EOF

# 添加执行权限
chmod +x ~/bin/stock_monitor.sh
```

#### 2. 配置 cron 任务

编辑 crontab:

```bash
crontab -e
```

添加以下配置(每个交易日收盘后15:10执行):

```cron
# 均线偏离度监控 - 每天15:10执行
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh

# 如果需要在港股收盘后再次执行,可以添加:
# 10 16 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

**cron 时间格式说明**:
```
*    *    *    *    *
┬    ┬    ┬    ┬    ┬
│    │    │    │    │
│    │    │    │    └─ 星期 (0-7, 0和7都表示周日)
│    │    │    └────── 月份 (1-12)
│    │    └─────────── 日期 (1-31)
│    └──────────────── 小时 (0-23)
└───────────────────── 分钟 (0-59)
```

**常用时间配置示例**:

```cron
# 每天15:10(A股收盘后)
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh

# 每天16:10(港股收盘后)
10 16 * * 1-5 /Users/russ/bin/stock_monitor.sh

# 每天15:10和16:10都执行
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
10 16 * * 1-5 /Users/russ/bin/stock_monitor.sh

# 仅周一到周五执行(避免周末)
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

#### 3. 验证 cron 任务

查看已配置的 cron 任务:

```bash
crontab -l
```

手动测试脚本:

```bash
~/bin/stock_monitor.sh
```

查看日志:

```bash
tail -f ~/PycharmProjects/stock-analysis/logs/ma_deviation_$(date +%Y%m%d).log
```

### 方案二: 使用 launchd (更现代的方式)

#### 1. 创建 plist 文件

```bash
cat > ~/Library/LaunchAgents/com.stock.monitor.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.stock.monitor</string>

    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>/Users/russ/bin/stock_monitor.sh</string>
    </array>

    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>15</integer>
        <key>Minute</key>
        <integer>10</integer>
    </dict>

    <key>StandardOutPath</key>
    <string>/Users/russ/PycharmProjects/stock-analysis/logs/launchd.log</string>

    <key>StandardErrorPath</key>
    <string>/Users/russ/PycharmProjects/stock-analysis/logs/launchd_error.log</string>

    <key>RunAtLoad</key>
    <false/>
</dict>
</plist>
EOF
```

#### 2. 加载 launchd 任务

```bash
# 加载任务
launchctl load ~/Library/LaunchAgents/com.stock.monitor.plist

# 查看任务状态
launchctl list | grep stock.monitor

# 手动触发测试
launchctl start com.stock.monitor
```

#### 3. 管理 launchd 任务

```bash
# 卸载任务
launchctl unload ~/Library/LaunchAgents/com.stock.monitor.plist

# 重新加载任务(修改配置后)
launchctl unload ~/Library/LaunchAgents/com.stock.monitor.plist
launchctl load ~/Library/LaunchAgents/com.stock.monitor.plist
```

## 其他系统配置

### Windows 系统

使用 Windows 任务计划程序:

1. 打开"任务计划程序" (搜索 `taskschd.msc`)
2. 创建基本任务
3. 设置触发器: 每天 15:10
4. 设置操作: 运行 Python 脚本
   - 程序: `python`
   - 参数: `scripts/position_analysis/run_ma_deviation_monitor.py --email --quiet`
   - 起始于: `C:\path\to\stock-analysis`

### Linux 系统

使用 cron (与 macOS 相同):

```bash
crontab -e
```

添加:

```cron
10 15 * * 1-5 /home/user/bin/stock_monitor.sh
```

## 监控与维护

### 查看日志

```bash
# 查看今日日志
tail -f ~/PycharmProjects/stock-analysis/logs/ma_deviation_$(date +%Y%m%d).log

# 查看最近7天的日志
ls -lt ~/PycharmProjects/stock-analysis/logs/ | head -10
```

### 日志清理

定期清理旧日志(可选):

```bash
# 删除30天前的日志
find ~/PycharmProjects/stock-analysis/logs -name "ma_deviation_*.log" -mtime +30 -delete
```

### 故障排查

**问题: 没有收到邮件**

1. 检查邮箱配置是否正确
2. 手动运行脚本测试: `python scripts/position_analysis/run_ma_deviation_monitor.py --email`
3. 查看日志文件中的错误信息

**问题: cron 任务没有执行**

1. 检查 cron 是否在运行: `ps aux | grep cron`
2. 确认脚本有执行权限: `ls -l ~/bin/stock_monitor.sh`
3. 检查系统日志: `tail -f /var/log/system.log | grep cron`

**问题: Python 找不到模块**

在 shell 脚本中使用完整的 Python 路径:

```bash
# 查找 Python 路径
which python3

# 或者激活虚拟环境(如果使用)
source /path/to/venv/bin/activate
```

## 高级配置

### 自定义重试次数

```bash
python scripts/position_analysis/run_ma_deviation_monitor.py --email --retry 5
```

### 只发送有预警时的邮件

编辑 `email_config.yaml`:

```yaml
send_no_alert_email: false   # 无预警时不发邮件
```

### 添加到多个收件人

```yaml
recipients:
  - user1@qq.com
  - user2@163.com
  - user3@gmail.com
```

### 仅在工作日执行

cron 配置中使用 `1-5` 限制为周一到周五:

```cron
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

## 安全建议

1. **保护配置文件**: `email_config.yaml` 包含敏感信息,不要提交到 Git

   ```bash
   echo "email_config.yaml" >> .gitignore
   ```

2. **定期更换授权码**: 建议每3-6个月更换一次邮箱授权码

3. **权限控制**: 确保脚本和配置文件权限合理

   ```bash
   chmod 700 ~/bin/stock_monitor.sh
   chmod 600 email_config.yaml
   ```

## 依赖项检查

确保已安装所需的 Python 包:

```bash
pip install pyyaml
```

## 总结

**推荐配置 (macOS)**:

1. 复制并配置 `email_config.yaml`
2. 创建 `~/bin/stock_monitor.sh` 脚本
3. 使用 cron 设置每天 15:10 执行
4. 查看日志确认运行正常

**执行流程**:

```
15:10 → cron触发 → 执行监控脚本 →
数据获取(带3次重试) → 生成报告 →
发送邮件 → 记录日志
```

**邮件通知**:

- ✅ 有预警: 发送详细预警报告(根据级别设置优先级)
- 📊 无预警: 可选择是否发送正常监控邮件

**失败处理**:

- 数据获取失败: 自动重试3次(间隔30s、60s、90s)
- 邮件发送失败: 记录到日志,返回错误码
- 脚本异常: 写入日志,cron可配置失败通知
