# å®šæ—¶ä»»åŠ¡é…ç½®æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨æœ¬åœ°é…ç½®å®šæ—¶ä»»åŠ¡,å®ç°æ¯æ—¥è‡ªåŠ¨ç›‘æ§å‡çº¿åç¦»åº¦å¹¶å‘é€é‚®ä»¶é€šçŸ¥ã€‚

## å‰ç½®å‡†å¤‡

### 1. é…ç½®é‚®ç®±

å¤åˆ¶é‚®ç®±é…ç½®æ¨¡æ¿å¹¶å¡«å†™ä¿¡æ¯:

```bash
cd /Users/russ/PycharmProjects/stock-analysis
cp email_config.yaml.template email_config.yaml
```

ç¼–è¾‘ `email_config.yaml`,å¡«å†™ä»¥ä¸‹ä¿¡æ¯:

```yaml
smtp:
  server: smtp.qq.com      # ä½ çš„é‚®ç®±SMTPæœåŠ¡å™¨
  port: 465                # SMTPç«¯å£

sender:
  email: your_email@qq.com        # å‘ä»¶é‚®ç®±
  password: your_app_password     # é‚®ç®±æˆæƒç (ä¸æ˜¯ç™»å½•å¯†ç !)
  name: è‚¡ç¥¨ç›‘æ§ç³»ç»Ÿ               # å‘ä»¶äººåç§°

recipients:
  - your_email@qq.com             # æ”¶ä»¶é‚®ç®±(å¯ä»¥å¤šä¸ª)
```

**é‡è¦**:
- `password` æ˜¯é‚®ç®±çš„**æˆæƒç **,ä¸æ˜¯ç™»å½•å¯†ç 
- QQé‚®ç®±æˆæƒç è·å–: é‚®ç®±è®¾ç½® â†’ è´¦æˆ· â†’ POP3/IMAP/SMTP â†’ ç”Ÿæˆæˆæƒç 
- 163é‚®ç®±æˆæƒç è·å–: é‚®ç®±è®¾ç½® â†’ POP3/SMTP/IMAP â†’ å¼€å¯æœåŠ¡å¹¶è·å–æˆæƒç 

### 2. æµ‹è¯•é‚®ä»¶å‘é€

è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½:

```bash
python scripts/position_analysis/run_ma_deviation_monitor.py --email
```

å¦‚æœé…ç½®æ­£ç¡®,ä½ å°†æ”¶åˆ°ä¸€å°é¢„è­¦é‚®ä»¶ã€‚

## macOS å®šæ—¶ä»»åŠ¡é…ç½®

macOS æ¨èä½¿ç”¨ cron æˆ– launchd å®ç°å®šæ—¶ä»»åŠ¡ã€‚

### æ–¹æ¡ˆä¸€: ä½¿ç”¨ cron (æ¨è)

#### 1. åˆ›å»ºç›‘æ§è„šæœ¬

åˆ›å»ºä¸€ä¸ª shell è„šæœ¬æ–¹ä¾¿ cron è°ƒç”¨:

```bash
# åˆ›å»ºè„šæœ¬ç›®å½•
mkdir -p ~/bin

# åˆ›å»ºç›‘æ§è„šæœ¬
cat > ~/bin/stock_monitor.sh << 'EOF'
#!/bin/bash

# é¡¹ç›®è·¯å¾„
PROJECT_DIR="/Users/russ/PycharmProjects/stock-analysis"

# Python ç¯å¢ƒ(æ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹)
PYTHON="/usr/bin/python3"

# æ—¥å¿—æ–‡ä»¶
LOG_DIR="$PROJECT_DIR/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/ma_deviation_$(date +\%Y\%m\%d).log"

# è¿è¡Œç›‘æ§å¹¶è®°å½•æ—¥å¿—
echo "========================================" >> "$LOG_FILE"
echo "å¼€å§‹ç›‘æ§: $(date)" >> "$LOG_FILE"
echo "========================================" >> "$LOG_FILE"

cd "$PROJECT_DIR"
$PYTHON scripts/position_analysis/run_ma_deviation_monitor.py --email --quiet >> "$LOG_FILE" 2>&1

EXIT_CODE=$?

echo "ç»“æŸç›‘æ§: $(date), é€€å‡ºç : $EXIT_CODE" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

exit $EXIT_CODE
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x ~/bin/stock_monitor.sh
```

#### 2. é…ç½® cron ä»»åŠ¡

ç¼–è¾‘ crontab:

```bash
crontab -e
```

æ·»åŠ ä»¥ä¸‹é…ç½®(æ¯ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜å15:10æ‰§è¡Œ):

```cron
# å‡çº¿åç¦»åº¦ç›‘æ§ - æ¯å¤©15:10æ‰§è¡Œ
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh

# å¦‚æœéœ€è¦åœ¨æ¸¯è‚¡æ”¶ç›˜åå†æ¬¡æ‰§è¡Œ,å¯ä»¥æ·»åŠ :
# 10 16 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

**cron æ—¶é—´æ ¼å¼è¯´æ˜**:
```
*    *    *    *    *
â”¬    â”¬    â”¬    â”¬    â”¬
â”‚    â”‚    â”‚    â”‚    â”‚
â”‚    â”‚    â”‚    â”‚    â””â”€ æ˜ŸæœŸ (0-7, 0å’Œ7éƒ½è¡¨ç¤ºå‘¨æ—¥)
â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€ æœˆä»½ (1-12)
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)
```

**å¸¸ç”¨æ—¶é—´é…ç½®ç¤ºä¾‹**:

```cron
# æ¯å¤©15:10(Aè‚¡æ”¶ç›˜å)
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh

# æ¯å¤©16:10(æ¸¯è‚¡æ”¶ç›˜å)
10 16 * * 1-5 /Users/russ/bin/stock_monitor.sh

# æ¯å¤©15:10å’Œ16:10éƒ½æ‰§è¡Œ
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
10 16 * * 1-5 /Users/russ/bin/stock_monitor.sh

# ä»…å‘¨ä¸€åˆ°å‘¨äº”æ‰§è¡Œ(é¿å…å‘¨æœ«)
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

#### 3. éªŒè¯ cron ä»»åŠ¡

æŸ¥çœ‹å·²é…ç½®çš„ cron ä»»åŠ¡:

```bash
crontab -l
```

æ‰‹åŠ¨æµ‹è¯•è„šæœ¬:

```bash
~/bin/stock_monitor.sh
```

æŸ¥çœ‹æ—¥å¿—:

```bash
tail -f ~/PycharmProjects/stock-analysis/logs/ma_deviation_$(date +%Y%m%d).log
```

### æ–¹æ¡ˆäºŒ: ä½¿ç”¨ launchd (æ›´ç°ä»£çš„æ–¹å¼)

#### 1. åˆ›å»º plist æ–‡ä»¶

```bash
cat > ~/Library/LaunchAgents/com.stock.monitor.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.stock.monitor</string>

    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>/Users/russ/bin/stock_monitor.sh</string>
    </array>

    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>15</integer>
        <key>Minute</key>
        <integer>10</integer>
    </dict>

    <key>StandardOutPath</key>
    <string>/Users/russ/PycharmProjects/stock-analysis/logs/launchd.log</string>

    <key>StandardErrorPath</key>
    <string>/Users/russ/PycharmProjects/stock-analysis/logs/launchd_error.log</string>

    <key>RunAtLoad</key>
    <false/>
</dict>
</plist>
EOF
```

#### 2. åŠ è½½ launchd ä»»åŠ¡

```bash
# åŠ è½½ä»»åŠ¡
launchctl load ~/Library/LaunchAgents/com.stock.monitor.plist

# æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
launchctl list | grep stock.monitor

# æ‰‹åŠ¨è§¦å‘æµ‹è¯•
launchctl start com.stock.monitor
```

#### 3. ç®¡ç† launchd ä»»åŠ¡

```bash
# å¸è½½ä»»åŠ¡
launchctl unload ~/Library/LaunchAgents/com.stock.monitor.plist

# é‡æ–°åŠ è½½ä»»åŠ¡(ä¿®æ”¹é…ç½®å)
launchctl unload ~/Library/LaunchAgents/com.stock.monitor.plist
launchctl load ~/Library/LaunchAgents/com.stock.monitor.plist
```

## å…¶ä»–ç³»ç»Ÿé…ç½®

### Windows ç³»ç»Ÿ

ä½¿ç”¨ Windows ä»»åŠ¡è®¡åˆ’ç¨‹åº:

1. æ‰“å¼€"ä»»åŠ¡è®¡åˆ’ç¨‹åº" (æœç´¢ `taskschd.msc`)
2. åˆ›å»ºåŸºæœ¬ä»»åŠ¡
3. è®¾ç½®è§¦å‘å™¨: æ¯å¤© 15:10
4. è®¾ç½®æ“ä½œ: è¿è¡Œ Python è„šæœ¬
   - ç¨‹åº: `python`
   - å‚æ•°: `scripts/position_analysis/run_ma_deviation_monitor.py --email --quiet`
   - èµ·å§‹äº: `C:\path\to\stock-analysis`

### Linux ç³»ç»Ÿ

ä½¿ç”¨ cron (ä¸ macOS ç›¸åŒ):

```bash
crontab -e
```

æ·»åŠ :

```cron
10 15 * * 1-5 /home/user/bin/stock_monitor.sh
```

## ç›‘æ§ä¸ç»´æŠ¤

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹ä»Šæ—¥æ—¥å¿—
tail -f ~/PycharmProjects/stock-analysis/logs/ma_deviation_$(date +%Y%m%d).log

# æŸ¥çœ‹æœ€è¿‘7å¤©çš„æ—¥å¿—
ls -lt ~/PycharmProjects/stock-analysis/logs/ | head -10
```

### æ—¥å¿—æ¸…ç†

å®šæœŸæ¸…ç†æ—§æ—¥å¿—(å¯é€‰):

```bash
# åˆ é™¤30å¤©å‰çš„æ—¥å¿—
find ~/PycharmProjects/stock-analysis/logs -name "ma_deviation_*.log" -mtime +30 -delete
```

### æ•…éšœæ’æŸ¥

**é—®é¢˜: æ²¡æœ‰æ”¶åˆ°é‚®ä»¶**

1. æ£€æŸ¥é‚®ç®±é…ç½®æ˜¯å¦æ­£ç¡®
2. æ‰‹åŠ¨è¿è¡Œè„šæœ¬æµ‹è¯•: `python scripts/position_analysis/run_ma_deviation_monitor.py --email`
3. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯

**é—®é¢˜: cron ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œ**

1. æ£€æŸ¥ cron æ˜¯å¦åœ¨è¿è¡Œ: `ps aux | grep cron`
2. ç¡®è®¤è„šæœ¬æœ‰æ‰§è¡Œæƒé™: `ls -l ~/bin/stock_monitor.sh`
3. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—: `tail -f /var/log/system.log | grep cron`

**é—®é¢˜: Python æ‰¾ä¸åˆ°æ¨¡å—**

åœ¨ shell è„šæœ¬ä¸­ä½¿ç”¨å®Œæ•´çš„ Python è·¯å¾„:

```bash
# æŸ¥æ‰¾ Python è·¯å¾„
which python3

# æˆ–è€…æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ(å¦‚æœä½¿ç”¨)
source /path/to/venv/bin/activate
```

## é«˜çº§é…ç½®

### è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°

```bash
python scripts/position_analysis/run_ma_deviation_monitor.py --email --retry 5
```

### åªå‘é€æœ‰é¢„è­¦æ—¶çš„é‚®ä»¶

ç¼–è¾‘ `email_config.yaml`:

```yaml
send_no_alert_email: false   # æ— é¢„è­¦æ—¶ä¸å‘é‚®ä»¶
```

### æ·»åŠ åˆ°å¤šä¸ªæ”¶ä»¶äºº

```yaml
recipients:
  - user1@qq.com
  - user2@163.com
  - user3@gmail.com
```

### ä»…åœ¨å·¥ä½œæ—¥æ‰§è¡Œ

cron é…ç½®ä¸­ä½¿ç”¨ `1-5` é™åˆ¶ä¸ºå‘¨ä¸€åˆ°å‘¨äº”:

```cron
10 15 * * 1-5 /Users/russ/bin/stock_monitor.sh
```

## å®‰å…¨å»ºè®®

1. **ä¿æŠ¤é…ç½®æ–‡ä»¶**: `email_config.yaml` åŒ…å«æ•æ„Ÿä¿¡æ¯,ä¸è¦æäº¤åˆ° Git

   ```bash
   echo "email_config.yaml" >> .gitignore
   ```

2. **å®šæœŸæ›´æ¢æˆæƒç **: å»ºè®®æ¯3-6ä¸ªæœˆæ›´æ¢ä¸€æ¬¡é‚®ç®±æˆæƒç 

3. **æƒé™æ§åˆ¶**: ç¡®ä¿è„šæœ¬å’Œé…ç½®æ–‡ä»¶æƒé™åˆç†

   ```bash
   chmod 700 ~/bin/stock_monitor.sh
   chmod 600 email_config.yaml
   ```

## ä¾èµ–é¡¹æ£€æŸ¥

ç¡®ä¿å·²å®‰è£…æ‰€éœ€çš„ Python åŒ…:

```bash
pip install pyyaml
```

## æ€»ç»“

**æ¨èé…ç½® (macOS)**:

1. å¤åˆ¶å¹¶é…ç½® `email_config.yaml`
2. åˆ›å»º `~/bin/stock_monitor.sh` è„šæœ¬
3. ä½¿ç”¨ cron è®¾ç½®æ¯å¤© 15:10 æ‰§è¡Œ
4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è¿è¡Œæ­£å¸¸

**æ‰§è¡Œæµç¨‹**:

```
15:10 â†’ cronè§¦å‘ â†’ æ‰§è¡Œç›‘æ§è„šæœ¬ â†’
æ•°æ®è·å–(å¸¦3æ¬¡é‡è¯•) â†’ ç”ŸæˆæŠ¥å‘Š â†’
å‘é€é‚®ä»¶ â†’ è®°å½•æ—¥å¿—
```

**é‚®ä»¶é€šçŸ¥**:

- âœ… æœ‰é¢„è­¦: å‘é€è¯¦ç»†é¢„è­¦æŠ¥å‘Š(æ ¹æ®çº§åˆ«è®¾ç½®ä¼˜å…ˆçº§)
- ğŸ“Š æ— é¢„è­¦: å¯é€‰æ‹©æ˜¯å¦å‘é€æ­£å¸¸ç›‘æ§é‚®ä»¶

**å¤±è´¥å¤„ç†**:

- æ•°æ®è·å–å¤±è´¥: è‡ªåŠ¨é‡è¯•3æ¬¡(é—´éš”30sã€60sã€90s)
- é‚®ä»¶å‘é€å¤±è´¥: è®°å½•åˆ°æ—¥å¿—,è¿”å›é”™è¯¯ç 
- è„šæœ¬å¼‚å¸¸: å†™å…¥æ—¥å¿—,cronå¯é…ç½®å¤±è´¥é€šçŸ¥
