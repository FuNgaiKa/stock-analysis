# 历史点位对比分析功能设计方案

## 1. 功能概述

基于当前主要指数的点位，查找历史上相似的市场状态，并通过统计学方法给出后续涨跌的概率预测。

## 2. 核心指标

### 2.1 需要分析的指数
- 上证指数 (sh000001)
- 沪深300 (sh000300)
- 创业板指 (sz399006)
- 科创50 (sh000688)
- 恒生科技 (HSTECH)

### 2.2 点位相似度定义
对于每个指数，定义"相似点位"为当前点位的 ±5% 区间内的历史数据点。

## 3. 分析方法

### 3.1 单指数历史对比
对每个指数执行：
1. 获取当前点位
2. 查找历史上在相似点位区间的所有时期
3. 统计这些时期后续N天(5/10/20/60日)的涨跌情况
4. 计算上涨/下跌的概率分布

### 3.2 多指数联合分析
- 寻找历史上多个指数**同时处于相似点位区间**的时期
- 这种多维度匹配能更准确地描述市场状态
- 统计这些"相似市场状态"后的走势

### 3.3 市场环境分类
将历史相似点位按市场环境分类：
- 牛市中期（快速上涨阶段）
- 牛市末期（冲顶阶段）
- 熊市中期（持续下跌）
- 震荡市（区间整理）

## 4. 概率统计模型

### 4.1 基础统计指标
```python
未来N日涨跌概率 = {
    "上涨概率": 上涨样本数 / 总样本数,
    "下跌概率": 下跌样本数 / 总样本数,
    "平均涨幅": mean(涨幅列表),
    "涨幅中位数": median(涨幅列表),
    "最大涨幅": max(涨幅列表),
    "最大跌幅": min(涨幅列表),
    "标准差": std(涨幅列表)
}
```

### 4.2 多周期分析
- 短期(5日): 反映短期波动
- 中短期(10日): 反映趋势启动
- 中期(20日): 反映月度趋势
- 长期(60日): 反映季度趋势

### 4.3 置信度计算
```python
置信度 = f(样本数量, 结果一致性, 时间分散度)

- 样本数量越多，置信度越高
- 涨跌结果越一致(如80%都上涨)，置信度越高
- 样本分散在不同年份，置信度越高(避免过拟合单一时期)
```

## 5. 实现方案

### 5.1 数据层
```python
class HistoricalPositionAnalyzer:
    """历史点位对比分析器"""

    def get_current_positions(self) -> dict:
        """获取当前各指数点位"""

    def find_similar_periods(self, index_code: str,
                            current_price: float,
                            tolerance: float = 0.05) -> pd.DataFrame:
        """查找历史相似点位时期"""

    def calculate_future_returns(self, similar_periods: pd.DataFrame,
                                 periods: list = [5, 10, 20, 60]) -> dict:
        """计算相似时期后续收益率"""

    def find_multi_index_match(self, positions: dict,
                               tolerance: float = 0.05) -> pd.DataFrame:
        """多指数联合匹配"""
```

### 5.2 分析层
```python
class ProbabilityAnalyzer:
    """概率统计分析器"""

    def calculate_probability(self, returns: list) -> dict:
        """计算涨跌概率及统计指标"""

    def calculate_confidence(self, sample_size: int,
                            consistency: float,
                            time_diversity: float) -> float:
        """计算置信度"""

    def classify_market_environment(self, period_data: pd.DataFrame) -> str:
        """市场环境分类"""
```

### 5.3 输出层
```python
class AnalysisReport:
    """分析报告生成器"""

    def generate_single_index_report(self, index_code: str) -> dict:
        """单指数分析报告"""

    def generate_multi_index_report(self) -> dict:
        """多指数联合分析报告"""

    def generate_conclusion(self) -> str:
        """生成综合结论(看多/看空/中性)"""
```

## 6. 输出示例

```
=================================================================
市场历史点位对比分析报告
分析时间: 2025-10-02
=================================================================

[当前市场点位]
上证指数: 3882.77
沪深300: 4521.33
创业板指: 2876.45
科创50: 1123.67
恒生科技: 4532.11

[单指数历史对比]

【上证指数 3882.77】
历史相似点位出现: 48次 (分布在2007/2015/2025年)

未来5日涨跌概率:
  - 上涨概率: 62.5% (30次)
  - 下跌概率: 37.5% (18次)
  - 平均涨幅: +1.2%
  - 涨幅中位数: +0.8%
  - 置信度: ★★★☆☆ (样本量偏少)

未来20日涨跌概率:
  - 上涨概率: 45.8% (22次)
  - 下跌概率: 54.2% (26次)
  - 平均跌幅: -2.3%
  - 置信度: ★★★☆☆

历史环境分类:
  - 牛市中期: 12次 → 后续大涨 (平均+15.3%)
  - 牛市末期: 7次 → 后续暴跌 (平均-25.6%)
  - 震荡市: 29次 → 继续震荡 (平均±3.2%)

[多指数联合分析]

找到 5 个历史时期，所有指数同时处于相似点位:
1. 2025-08-15 ~ 2025-09-30 (当前)
2. 2015-04-10 ~ 2015-04-20 (牛市末期) → 后续暴跌
3. 2007-05-15 ~ 2007-05-25 (牛市中期) → 后续大涨
...

多指数匹配后的概率:
  - 未来20日上涨概率: 40%
  - 未来20日下跌概率: 60%
  - 置信度: ★★★★☆ (多维度匹配)

[综合结论]

方向判断: 偏空 (置信度60%)

理由:
1. 当前点位处于历史高位区间(前5%)
2. 多指数联合分析显示，历史相似状态后下跌概率较高
3. 当前在高位区间停留时间(27天)超过历史平均水平
4. 类似2015年牛市末期特征，需警惕回调风险

建议:
- 短期(5-10日): 可能震荡或小幅上涨
- 中期(20-60日): 回调风险较大，建议降低仓位
- 风险提示: 该分析基于历史统计，不构成投资建议

=================================================================
```

## 7. 技术要点

### 7.1 数据处理
- 使用 akshare 获取各指数历史数据
- 数据缓存机制(避免重复请求)
- 异常数据清洗(停牌、异常波动等)

### 7.2 性能优化
- 历史数据本地缓存
- 相似度计算向量化(numpy)
- 多进程并行处理多个指数

### 7.3 统计学考虑
- 样本量过少(<10)时给出警告
- 时间加权(近期样本权重更高)
- 避免数据窥探偏差(Look-ahead bias)

## 8. 扩展方向

### 8.1 增强因子

#### 8.1.1 量价配合维度
```python
量价匹配度 = {
    "相似点位时的成交量分位数": 当前成交量在历史同点位的分位数,
    "量价背离检测": 价格新高但成交量萎缩(见顶信号) / 价格新低但成交量放大(见底信号),
    "换手率对比": 历史相似点位的平均换手率 vs 当前换手率
}
```
**价值**:
- 放量突破 vs 缩量突破，成功率差异显著
- 底部放量 vs 顶部放量，后续走势完全不同

#### 8.1.2 市场情绪指标
```python
情绪因子 = {
    "涨跌停比": (涨停数 - 跌停数) / 总股票数,
    "破板率": 炸板数 / 涨停数,  # 高破板率=情绪转弱
    "北向资金流向": 近N日净流入累计,
    "融资融券余额": 两融余额变化趋势,
    "ETF申赎": 宽基ETF的申购赎回情况,
    "新股破发率": 新股首日破发数量占比
}
```
**价值**:
- 涨停潮(>100只) 通常出现在牛市加速或见顶
- 北向资金连续大幅流出往往是调整信号
- 新股破发率攀升通常是熊市特征

#### 8.1.3 估值维度
```python
估值因子 = {
    "PE分位数": 当前PE在历史的分位数位置,
    "PB分位数": 当前PB在历史的分位数位置,
    "股债收益比": (1/PE) / 10年期国债收益率,
    "风险溢价": 股票预期收益率 - 无风险利率
}
```
**价值**:
- 同样3000点，PE=15 和 PE=50 的后续走势完全不同
- 估值高位+点位高位 = 双重风险
- 估值低位+点位低位 = 安全边际

#### 8.1.4 宏观环境
```python
宏观因子 = {
    "政策周期": 宽松/中性/紧缩,
    "利率环境": 降息/加息周期,
    "汇率走势": 人民币升值/贬值,
    "M2增速": 货币供应量增速,
    "PMI指数": 制造业景气度,
    "信贷数据": 社融规模、新增贷款
}
```
**价值**:
- 降息周期 vs 加息周期，股市表现截然不同
- 宽松政策期间，即使点位相同，上涨概率也更高

#### 8.1.5 技术形态
```python
技术形态因子 = {
    "均线系统": 5/10/20/60日均线多头/空头排列,
    "MACD状态": 金叉/死叉、柱状图变化,
    "相对强弱RSI": 超买(>70) / 超卖(<30),
    "布林带位置": 上轨/中轨/下轨附近,
    "前期高低点": 距离前期高点/低点的距离
}
```
**价值**:
- 同样点位，均线多头 vs 空头，概率差异巨大
- 连续突破前高 vs 反弹至前高受阻，性质不同

#### 8.1.6 行业轮动
```python
行业因子 = {
    "领涨行业": 近期涨幅前3的行业,
    "行业轮动速度": 领涨板块切换频率,
    "行业集中度": 涨幅是否集中在少数行业,
    "防御性板块表现": 医药/消费/公用事业相对强弱
}
```
**价值**:
- 牛市: 周期股领涨 → 成长股接力 → 消费股补涨
- 熊市: 防御性板块抗跌，周期股暴跌
- 快速轮动通常是行情末期特征

### 8.2 相似度算法优化

#### 8.2.1 从单一点位匹配 → 多维度距离
```python
# 当前: 简单的±5%区间
similar = (price >= current * 0.95) & (price <= current * 1.05)

# 优化: 多维欧氏距离
from scipy.spatial.distance import euclidean

def calculate_similarity(current_state, historical_state):
    """
    current_state = {
        'sh000001': 3882,
        'sh000300': 4521,
        'volume_percentile': 0.65,
        'sentiment_score': 0.72,
        'pe_percentile': 0.85
    }
    """
    # 归一化处理
    normalized_current = normalize(current_state)
    normalized_historical = normalize(historical_state)

    # 计算加权距离
    weights = {
        'price': 0.4,      # 点位权重
        'volume': 0.15,    # 成交量权重
        'sentiment': 0.15, # 情绪权重
        'valuation': 0.2,  # 估值权重
        'macro': 0.1       # 宏观权重
    }

    distance = weighted_euclidean_distance(
        normalized_current,
        normalized_historical,
        weights
    )

    similarity = 1 / (1 + distance)
    return similarity
```

#### 8.2.2 DTW (动态时间规整) 算法
```python
from dtw import dtw

# 不只看某一天的点位，而是看一段时间的走势形态
current_trend = recent_20_days_price_series
historical_trend = historical_20_days_price_series

distance, path = dtw(current_trend, historical_trend)
```
**价值**: 识别"形态相似"而非"点位相似"
- 例如: 连续3天小阳线突破 vs 单日大阳线突破，后续走势可能不同

### 8.3 概率模型改进

#### 8.3.1 条件概率分层
```python
# 不同条件下的概率分布
P(上涨 | 相似点位) = 60%  # 基础概率

# 分层细化
P(上涨 | 相似点位 + 牛市环境 + 放量突破 + 估值合理) = 85%
P(上涨 | 相似点位 + 熊市环境 + 缩量反弹 + 估值高位) = 25%
P(上涨 | 相似点位 + 震荡市 + 成交量中性 + 估值中位) = 50%
```

#### 8.3.2 贝叶斯更新
```python
# 先验概率 (基于历史统计)
prior_prob = 0.60

# 似然函数 (当前条件匹配度)
likelihood = calculate_likelihood(current_conditions)

# 后验概率 (贝叶斯更新)
posterior_prob = (likelihood * prior_prob) / evidence
```

#### 8.3.3 蒙特卡洛模拟
```python
def monte_carlo_simulation(similar_periods, n_simulations=10000):
    """
    对历史相似情况进行随机抽样模拟
    """
    outcomes = []
    for _ in range(n_simulations):
        # 随机抽取一个历史案例
        sample = random.choice(similar_periods)
        future_return = sample['20d_return']
        outcomes.append(future_return)

    return {
        'mean': np.mean(outcomes),
        'median': np.median(outcomes),
        'std': np.std(outcomes),
        'var_95': np.percentile(outcomes, 5),  # 5%分位数 (VaR)
        'cvar_95': np.mean([x for x in outcomes if x <= np.percentile(outcomes, 5)])  # CVaR
    }
```
**价值**: 给出风险度量指标，不只是涨跌概率

#### 8.3.4 Kelly公式仓位计算
```python
def kelly_position(win_prob, avg_win, avg_loss):
    """
    Kelly公式: f* = (p*b - q) / b
    f*: 最优仓位比例
    p: 胜率
    b: 盈亏比 (平均盈利/平均亏损)
    q: 败率 = 1-p
    """
    if avg_loss == 0:
        return 0

    b = abs(avg_win / avg_loss)
    q = 1 - win_prob

    kelly = (win_prob * b - q) / b

    # 半凯利 (更保守)
    half_kelly = kelly * 0.5

    return max(0, min(1, half_kelly))  # 限制在0-1之间
```
**价值**: 不只告诉你方向，还告诉你应该配置多少仓位

### 8.4 异常检测与过滤

#### 8.4.1 识别"黑天鹅"事件
```python
# 标记历史异常时期，避免误导
blackswan_periods = {
    '2008-09-15': '雷曼破产',
    '2015-06-15': '股灾熔断',
    '2020-03-09': '全球疫情恐慌',
    '2024-02-05': '日本股灾引发全球暴跌'
}

# 在统计时可以选择:
# 1. 完全剔除这些样本
# 2. 单独统计"正常时期"和"极端时期"的概率
# 3. 给极端时期样本降权
```

#### 8.4.2 制度变化识别
```python
# 市场制度变化会导致历史数据失效
regime_changes = {
    '2019-06-13': '科创板开板',
    '2020-08-24': '创业板注册制',
    '2023-09-01': '印花税下调',
    '2024-04-12': '北交所融资融券'
}

# 建议: 近期数据权重更高
def time_decay_weight(date, half_life=365*2):
    """时间衰减权重，2年半衰期"""
    days_ago = (datetime.now() - date).days
    return 0.5 ** (days_ago / half_life)
```

### 8.5 实战交易策略

#### 8.5.1 分级操作信号
```python
信号强度分级 = {
    "强买入 (概率>75%, 置信度>80%)": "加仓至8成",
    "买入 (概率>65%, 置信度>70%)": "加仓至6-7成",
    "中性 (概率45%-55%)": "维持当前仓位",
    "卖出 (概率<35%, 置信度>70%)": "减仓至3-4成",
    "强卖出 (概率<25%, 置信度>80%)": "减仓至2成以下"
}
```

#### 8.5.2 止损止盈设置
```python
# 基于历史统计设置止损止盈
stop_loss = current_price * (1 - abs(历史最大回撤_95分位数))
take_profit = current_price * (1 + 历史平均涨幅_75分位数)

# 动态调整
if 上涨概率 > 70%:
    止损可以放宽一些
if 下跌概率 > 70%:
    止损要更严格
```

#### 8.5.3 网格/定投策略
```python
# 基于概率的分批建仓
if 上涨概率 60%-70%:
    分3批建仓, 每批33%
elif 上涨概率 70%-80%:
    分2批建仓, 每批50%
elif 上涨概率 > 80%:
    一次性建仓
```

### 8.6 可视化增强

#### 8.6.1 相似度热力图
```python
# 绘制当前状态与历史各时期的多维相似度
heatmap(
    x = 历史日期,
    y = ['点位', '成交量', '估值', '情绪', '宏观'],
    values = 相似度矩阵
)
```

#### 8.6.2 概率漏斗图
```python
# 显示多层过滤后样本数和概率变化
漏斗图:
  - 相似点位: 100个样本, 上涨概率60%
  - + 成交量放大: 45个样本, 上涨概率72%
  - + 估值合理: 20个样本, 上涨概率85%
  - + 宏观宽松: 8个样本, 上涨概率90%
```

#### 8.6.3 历史案例对比K线
```python
# 并排展示当前走势 vs 历史最相似的3个案例
subplot(2, 2):
  - 当前走势 (实时)
  - 2007-05-15 案例 (后续+18.3%)
  - 2015-04-12 案例 (后续-12.7%)
  - 2021-02-10 案例 (后续+3.2%)
```

### 8.7 回测与验证

#### 8.7.1 滚动回测
```python
# 模拟实盘: 每个历史时点用之前数据预测，看准确率
for date in historical_dates:
    # 只用date之前的数据训练
    train_data = data[data.index < date]

    # 预测date之后的走势
    prediction = model.predict(train_data)

    # 验证实际走势
    actual = data.loc[date + timedelta(days=20)]

    # 统计准确率
    accuracy = calculate_accuracy(prediction, actual)
```

#### 8.7.2 策略回测报告
```python
回测指标 = {
    "胜率": 预测正确次数 / 总预测次数,
    "盈亏比": 平均盈利 / 平均亏损,
    "年化收益率": (期末 / 期初) ** (365/天数) - 1,
    "最大回撤": max(peak - trough),
    "夏普比率": (年化收益 - 无风险收益) / 收益波动率,
    "卡玛比率": 年化收益 / 最大回撤
}
```

### 8.8 机器学习优化

#### 8.8.1 特征工程
```python
# 构造更多衍生特征
features = {
    # 点位特征
    'price_ma5_ratio': current_price / ma5,
    'price_ma20_ratio': current_price / ma20,
    'price_percentile': 当前价格在过去1年的分位数,

    # 动量特征
    'momentum_5d': (close - close.shift(5)) / close.shift(5),
    'momentum_20d': (close - close.shift(20)) / close.shift(20),
    'acceleration': momentum_5d - momentum_5d.shift(5),

    # 波动率特征
    'volatility_20d': close.pct_change().rolling(20).std(),
    'atr': average_true_range(20),

    # 成交量特征
    'volume_ma5_ratio': volume / volume.rolling(5).mean(),
    'volume_price_corr': rolling_correlation(volume, price, 20),

    # 相对强度
    'relative_strength': sh000001 / hs300,  # 上证相对沪深300
    'beta': calculate_beta(stock, index, 60)
}
```

#### 8.8.2 模型融合
```python
# 集成多个模型，投票决策
models = {
    'logistic_regression': LogisticRegression(),
    'random_forest': RandomForestClassifier(),
    'xgboost': XGBClassifier(),
    'lightgbm': LGBMClassifier(),
    'neural_network': MLPClassifier()
}

# 加权投票
final_prediction = (
    0.15 * lr_pred +
    0.25 * rf_pred +
    0.30 * xgb_pred +
    0.20 * lgb_pred +
    0.10 * nn_pred
)
```

#### 8.8.3 在线学习
```python
# 模型持续学习，自适应市场变化
class OnlineLearningModel:
    def __init__(self):
        self.model = SGDClassifier()  # 支持增量学习

    def update(self, new_data, new_label):
        """每日收盘后用当日数据更新模型"""
        self.model.partial_fit(new_data, new_label)

    def predict(self, X):
        return self.model.predict_proba(X)
```

### 8.9 风险控制模块

#### 8.9.1 多层风控
```python
风控检查 = {
    "Level 1 - 信号质量": {
        "样本量 < 10": "拒绝交易",
        "置信度 < 50%": "拒绝交易"
    },

    "Level 2 - 市场环境": {
        "连续涨停超100只": "警惕追高",
        "连续跌停超100只": "警惕抄底"
    },

    "Level 3 - 仓位控制": {
        "单次交易 ≤ 总资金30%": "分散风险",
        "累计持仓 ≤ 总资金80%": "保留现金"
    },

    "Level 4 - 止损机制": {
        "单笔亏损 > 3%": "强制止损",
        "浮盈回撤 > 50%": "部分止盈"
    }
}
```

#### 8.9.2 压力测试
```python
# 极端情况下的策略表现
stress_tests = {
    "单日暴跌10%": simulate_strategy_under_crash(-0.10),
    "连续下跌20%": simulate_strategy_under_bear_market(-0.20),
    "黑天鹅事件": simulate_black_swan_scenario()
}
```

### 8.10 报告系统优化

#### 8.10.1 置信区间可视化
```python
# 不只给点估计，还要给区间估计
预测结果 = {
    "点估计": "未来20日上涨概率65%",
    "95%置信区间": [55%, 75%],
    "解读": "我们有95%的把握认为真实上涨概率在55%-75%之间"
}
```

#### 8.10.2 归因分析
```python
# 解释为什么给出这个结论
决策归因 = {
    "点位因素贡献": +15%,  # 历史同点位上涨概率高
    "估值因素贡献": -5%,   # 当前估值偏高
    "情绪因素贡献": +10%,  # 市场情绪积极
    "宏观因素贡献": +5%,   # 政策环境友好
    "技术因素贡献": +5%,   # 技术形态向好
    "综合结论": +30% → 上涨概率65%
}
```

#### 8.10.3 错误分析
```python
# 定期分析预测失败的案例
错误案例分析 = {
    "2024-08-05预测失败": {
        "预测": "上涨概率70%",
        "实际": "下跌8%",
        "原因": "日本央行加息引发全球股灾，黑天鹅事件",
        "改进": "增加海外市场风险监控"
    }
}
```

## 9. 参考案例

一些量化博主实现的类似策略：
- **指数温度策略**: 计算指数所处历史分位数
- **历史回测策略**: 基于历史相似形态预测
- **多因子择时**: 结合点位、估值、情绪等多维度

## 10. 开发计划

### Phase 1: 基础功能
- [ ] 单指数历史点位查找
- [ ] 基础概率统计
- [ ] 简单报告输出

### Phase 2: 增强分析
- [ ] 多指数联合匹配
- [ ] 市场环境分类
- [ ] 置信度计算

### Phase 3: 高级功能
- [ ] 成交量等增强因子
- [ ] 可视化报告
- [ ] 机器学习模型

---

**备注**: 此功能纯基于历史统计，不保证未来准确性。历史相似≠未来相同，需结合基本面、政策面等综合判断。
