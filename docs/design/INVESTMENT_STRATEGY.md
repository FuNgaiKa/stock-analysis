# 股票分析系统 - 投资策略与分析逻辑总结

## 目录
1. [系统架构概览](#系统架构概览)
2. [三大核心模块](#三大核心模块)
3. [分析维度详解](#分析维度详解)
4. [投资建议逻辑](#投资建议逻辑)
5. [风险控制机制](#风险控制机制)
6. [持仓建议规则](#持仓建议规则)

---

## 系统架构概览

```
投资分析系统
├── Unified Analysis (统一分析)
│   └── 整合所有资产类型的分析
├── Comprehensive Asset Analysis (综合资产分析)
│   └── 指数、商品、加密货币
├── Sector Analysis (板块分析)
│   └── 板块ETF和个股
└── Position Analysis (持仓分析)
    └── 历史点位对比分析
```

### 分析对象覆盖
- **4大科技指数**: 创业板指(CYBZ)、科创50、恒生科技、纳斯达克
- **宽基指数**: 沪深300
- **大宗商品**: 黄金
- **加密货币**: 比特币
- **板块ETF**: 创新药、电池、化工、煤炭、白酒、证券等14个
- **个股**: 三花智控、阿里巴巴(港股)、指南针等

---

## 三大核心模块

### 1. Unified Analysis (统一分析)
**路径**: `scripts/unified_analysis/run_unified_analysis.py`

**核心职责**:
- 一次性分析所有资产(指数+板块+个股)
- 生成汇总表格
- 整合不同分析器的输出
- 发送统一邮件报告

**关键配置**: `scripts/unified_analysis/unified_config.py`
- 定义了30+个资产
- 区分`comprehensive`(指数类)和`sector`(板块类)两种分析器

**关键输出**:
```
| 标的名称 | 当前价格 | 涨跌幅 | 方向判断 | 建议仓位 | 20日上涨概率 | 风险等级 | 持有建议 |
```

---

### 2. Comprehensive Asset Analysis (综合资产分析)
**路径**: `scripts/comprehensive_asset_analysis/asset_reporter.py`

**分析对象**: 指数、商品、加密货币

**11大分析维度**:

| # | 维度 | 说明 | 权重 |
|---|------|------|------|
| 1 | 历史点位分析 | 基于历史相似点位的涨跌概率统计 | 30% |
| 2 | 技术面分析 | MACD/RSI/KDJ/布林带/ATR/DMI/ADX/均线/背离 | 20% |
| 3 | 资金面分析 | 北向资金(A股)/南向资金(港股) | 15% |
| 4 | 估值分析 | PE/PB分位数(仅支持沪深300/创业板指) | 10% |
| 5 | 市场情绪 | 涨跌停统计 | 5% |
| 6 | 风险评估 | 综合风险评分(0-1) | - |
| 7 | 综合判断 | 方向+仓位+策略 | - |
| 8 | 成交量分析 | OBV/量比/量价关系 | - |
| 9 | 支撑压力位 | 轴心点/斐波那契 | - |
| 10 | 市场宽度 | 新高新低统计(A股) | - |
| 11 | 恐慌指数 | VIX(美股)/VHSI(港股)/CNVI(A股) | - |

**核心方法**:
- `analyze_single_asset()`: 分析单个资产
- `_generate_judgment()`: 生成综合判断
- `_calculate_risk_score()`: 计算风险评分

---

### 3. Sector Analysis (板块分析)
**路径**: `scripts/sector_analysis/sector_reporter.py`

**分析对象**: 板块ETF、个股

**支持的板块** (14个):
- 港股: 创新药(513120)、电池(159755)
- A股技术: 半导体(512480)、软件(515230)
- A股周期: 化工(516020)、煤炭(515220)、钢铁(515210)
- A股消费: 白酒(512690)
- A股金融: 证券(512880)、银行(512800)、保险(512910)
- A股材料: 有色金属(159871)、稀土(516780)
- A股媒体: 游戏(159869)、传媒(512980)

**分析流程**:
1. 数据获取(多数据源管理器)
2. 11维度分析(同comprehensive)
3. 风险评分计算
4. 综合判断与建议
5. 投资建议总结分类

---

## 分析维度详解

### 维度1: 历史点位分析
```python
# 核心逻辑
1. 获取5年历史数据
2. 找当前点位±5%的相似点位(过滤最近5天)
3. 统计相似点位后20日、60日的未来收益
4. 计算上涨概率、平均收益、中位数收益
5. 置信度 = min(100%, 样本数/30 * 100%)
```

**关键指标**:
- `up_prob_20d`: 20日上涨概率 (0-1)
- `mean_return_20d`: 平均预期收益
- `confidence`: 置信度(样本量相关)

---

### 维度6: 风险评估
```python
# 风险评分构成 (总分1.0)
risk_score = 0.0

# 1. 历史概率风险 (权重30%)
if down_prob_20d > 0.7:
    risk_score += 0.3  # 下跌概率>70%
elif down_prob_20d > 0.6:
    risk_score += 0.2  # 下跌概率>60%
elif down_prob_20d > 0.5:
    risk_score += 0.1

# 2. 技术面风险 (权重30%)
# MACD顶背离: +0.15
# RSI严重超买(>80): +0.1
# RSI超买(>70): +0.05
# MA20偏离>15%: +0.1

# 3. 资金面风险 (权重20%)
if sentiment_score < 30:
    risk_score += 0.2  # 资金大幅流出
elif sentiment_score < 40:
    risk_score += 0.1  # 资金持续流出

# 风险等级
if risk_score >= 0.7:
    risk_level = "极高风险"  # 红色
elif risk_score >= 0.5:
    risk_level = "高风险"    # 橙色
elif risk_score >= 0.3:
    risk_level = "中风险"    # 黄色
else:
    risk_level = "低风险"    # 绿色
```

---

### 维度7: 综合判断
**核心算法**:
```python
# 综合判断条件
up_prob_20d = 历史点位分析中的20日上涨概率
risk_score = 风险评分(0-1)

# 方向判断
if up_prob_20d >= 0.7 and risk_score < 0.3:
    direction = "强烈看多✅✅"
    position = "70-80%"
elif up_prob_20d >= 0.6 and risk_score < 0.5:
    direction = "看多✅"
    position = "60-70%"
elif up_prob_20d >= 0.5 and risk_score < 0.6:
    direction = "中性偏多⚖️"
    position = "50-60%"
elif up_prob_20d < 0.4 or risk_score > 0.7:
    direction = "看空🔴"
    position = "20-30%"
else:
    direction = "中性⚖️"
    position = "40-50%"
```

---

## 投资建议逻辑

### 操作策略生成规则

```python
strategies = []

# 基于历史概率
if up_prob_20d > 0.6:
    strategies.append("历史概率支持,可以配置")
elif up_prob_20d < 0.4:
    strategies.append("历史概率偏空,建议减仓")

# 基于技术面
if MACD顶背离:
    strategies.append("MACD顶背离,警惕回调")

if rsi_value > 70:
    strategies.append("RSI超买,不追高")
elif rsi_value < 30:
    strategies.append("RSI超卖,可分批买入")

# 基于风险
if risk_score > 0.7:
    strategies.append("⚠️ 高风险,强烈建议减仓")
elif risk_score < 0.3:
    strategies.append("✅ 低风险,可以持有")

# 特殊资产提示
if category == 'commodity':
    strategies.append("💰 避险资产,关注地缘政治")
elif category == 'crypto':
    strategies.append("₿ 波动较大,控制仓位")
```

---

## 风险控制机制

### 1. 多因子风险权重
```
历史概率风险  30%  (下跌概率)
技术面风险    30%  (背离、超买)
资金面风险    20%  (资金流向)
其他风险      20%  (保留余量)
```

### 2. 技术风险指标
- **MACD顶背离**: 价格创新高但MACD不创新高 (高风险信号)
- **RSI超买**: RSI > 70 (温和预警), > 80 (严重预警)
- **均线偏离**: 价格偏离MA20超过15% (过度乖离)

### 3. 资金面风险
- **资金流出信号**: 情绪评分 < 40 (持续流出)
- **极端流出**: 情绪评分 < 30 (大幅流出)

---

## 持仓建议规则

### 关键特性: 风险优化的持有建议

系统采用**风险优化逻辑**, 即使看空也可能给出持有建议:

```python
# 持有建议增强逻辑 (asset_reporter.py L1025-L1036)

if direction == "看空🔴" and risk_score < 0.3:
    # 看空但低风险,可以继续持有
    if config['category'] == 'commodity':
        # 避险资产虽然看空,但可以继续持有(如黄金)
        strategies.append("✅ 低风险,可以持有")
    elif up_prob_20d >= 0.35:
        # 看空但概率不是特别差(35%-40%),低风险可以持有
        strategies.append("✅ 低风险,可以持有")
```

### 汇总表格中的持有建议
```python
# 从strategies中提取包含"持有"的建议
for strategy in strategies:
    if "持有" in strategy:
        hold_suggestion = strategy
        break
```

### 投资建议分类
```
✅ 强烈推荐  (高胜率+低风险)
  └─ 条件: direction in ['强烈看多','看多'] and up_prob >= 60%

⚖️ 中性持有  (观望为主)
  └─ 条件: 上述条件都不符合且不是看空

⚠️ 减仓观望  (风险较高)
  └─ 条件: direction == '看空' or up_prob < 40%
```

---

## 关键指标速查表

| 指标 | 范围 | 解读 |
|------|------|------|
| **上涨概率** | 0-1 | > 60% 看多, < 40% 看空 |
| **风险评分** | 0-1 | < 0.3 低风险, > 0.7 极高风险 |
| **RSI** | 0-100 | > 70 超买, < 30 超卖, 30-70 正常 |
| **置信度** | 0-1 | 样本多则高, min(样本/30, 100%) |
| **MA偏离** | % | > 15% 过度乖离, < 5% 正常 |
| **MACD** | - | 金叉 看多, 死叉 看空 |
| **建议仓位** | 20-80% | 随方向和风险调整 |

---

## 实际应用示例

### Example 1: 创业板指(CYBZ)
```
当前价格: 1234.56 元
20日上涨概率: 62%
风险评分: 0.35 (中风险)
MACD状态: 金叉
RSI: 65 (正常)

判断结果:
  方向: 看多✅ (up_prob >= 0.6 and risk < 0.5)
  建议仓位: 60-70%
  策略: 
    - 历史概率支持,可以配置
    - RSI健康,可以参与
    - 关注放量突破
```

### Example 2: 黄金(避险资产)
```
当前价格: 2100 美元
20日上涨概率: 35%
风险评分: 0.25 (低风险)

判断结果:
  方向: 看空🔴 (up_prob < 0.4)
  建议仓位: 20-30%
  策略:
    - ✅ 低风险,可以持有     ← 特殊逻辑!
    - 💰 避险资产,关注地缘政治
  持有建议: ✅ 低风险,可以持有
```

### Example 3: 比特币(加密货币)
```
当前价格: 45000 美元
20日上涨概率: 55%
风险评分: 0.65 (高风险)

判断结果:
  方向: 中性⚖️
  建议仓位: 40-50%
  策略:
    - ⚠️ 高风险,强烈建议减仓
    - ₿ 波动较大,控制仓位,注意风险
```

---

## 数据来源与可靠性

### 支持的数据源
1. **A股数据**: AShare / AKShare
2. **港股数据**: YFinance / 东方财富
3. **美股数据**: YFinance / 美股官方数据
4. **加密数据**: CoinGecko / Binance
5. **大宗商品**: 商品交易所数据

### 数据源故障切换
系统实现了`DataSourceManager`多数据源管理:
```python
# 优先级: 指定源 > 首选源 > 自动选择
df = data_source_manager.get_stock_data(
    symbol=symbol,
    period="5y",
    market="CN",
    prefer_source=None  # None自动选择最可靠的
)
```

---

## 输出报告类型

### 1. 统一报告(Markdown)
**生成方式**:
```bash
python scripts/unified_analysis/run_unified_analysis.py --format markdown
```

**包含内容**:
- 汇总表格(所有资产)
- 详细分析(按资产类型)
- 投资建议总结

### 2. 邮件报告
**发送对象**: 配置文件中的收件人列表

```bash
python scripts/unified_analysis/run_unified_analysis.py --email
```

### 3. 历史点位报告
**类型**: Text/HTML/Markdown

---

## 最佳实践建议

### 交易决策流程
```
1. 查看汇总表格 → 快速了解全局
2. 查看持有建议列 → 掌握核心观点
3. 查看方向判断+风险等级 → 评估风险收益比
4. 查看操作策略 → 制定交易计划
5. 查看技术指标 → 选择入场时机
```

### 风险管理建议
```
✅ DO:
  - 遵守建议仓位(20-80%范围)
  - 高风险资产减仓或观望
  - 多因子确认后才决策
  - 定期复查报告(至少周更新)

❌ DON'T:
  - 单纯依赖上涨概率决策
  - 忽视风险评分
  - 全仓操作(即使看多)
  - 忽视特殊资产提示(加密/商品)
```

---

## 系统限制与注意

1. **历史点位分析假设**
   - 历史会重演(统计学假设)
   - 需要足够样本(至少10个相似点位)
   - 置信度与样本量成正相关

2. **技术指标局限**
   - 不适用于突发事件(黑天鹅)
   - 市场结构变化时失效
   - 需要与基本面结合

3. **数据源限制**
   - 免费数据源更新延迟(1-2天)
   - 某些指数无估值数据
   - 国际数据可能有时差

4. **模型约束**
   - 不考虑流动性变化
   - 不包含宏观事件影响
   - 不支持高频交易

---

**生成时间**: 2025-10-20
**系统版本**: 1.0 (Phase 1 + Phase 2 完整版)
**维护者**: Claude Code
