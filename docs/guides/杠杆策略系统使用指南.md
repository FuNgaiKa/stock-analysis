# 杠杆策略系统使用指南

> 基于《杠杆与风险管理指南.md》理念设计的智能化杠杆决策系统

---

## 📖 目录

1. [系统简介](#系统简介)
2. [核心功能](#核心功能)
3. [快速开始](#快速开始)
4. [五维度评分](#五维度评分)
5. [Kelly公式应用](#kelly公式应用)
6. [实战案例](#实战案例)
7. [注意事项](#注意事项)

---

## 系统简介

### 🎯 设计理念

杠杆策略系统整合了项目中的多个分析模块，提供**一站式杠杆决策建议**：

- ✅ **五维度市场评分** - 从13维度聚合为5大类（估值、政策、情绪、技术、资金）
- ✅ **Kelly公式计算** - 基于市场状态自动推算最优杠杆
- ✅ **市场环境识别** - 牛市初期/中期/末期等8种状态
- ✅ **综合杠杆建议** - 结合市场环境给出实战建议
- ✅ **操作指导** - 具体的建仓、止损、止盈策略

### 🏗️ 系统架构

```
杠杆策略系统
├── src/analyzers/macro/leverage/
│   ├── leverage_strategy_engine.py    # 核心引擎
│   └── kelly_calculator.py            # Kelly公式计算器
├── scripts/leverage_management/
│   └── run_leverage_strategy.py       # CLI入口脚本
└── 整合模块:
    ├── MarketStateDetector            # 13维度市场状态检测
    ├── ValuationAnalyzer              # 估值分析
    ├── MarketSentimentIndex           # 市场情绪分析
    └── DynamicPositionManager         # 动态仓位管理
```

---

## 核心功能

### 1️⃣ 五维度市场评分

| 维度 | 聚合来源 (13维度) | 权重 | 说明 |
|------|-----------------|------|------|
| **估值** | valuation | 25% | PE/PB分位数，判断估值高低 |
| **政策** | capital_flow + leverage | 20% | 北向资金、融资融券，代理政策宽松度 |
| **情绪** | sentiment + breadth + leverage | 15% | 涨跌停、市场宽度、杠杆资金活跃度 |
| **技术** | trend + price_change + technical + slope | 20% | 均线趋势、价格动量、技术形态、斜率 |
| **资金** | main_fund + institution + volume | 20% | 主力资金、机构行为、成交量 |

**综合评分**: -1.0 (极度看空) ~ +1.0 (极度看多)

### 2️⃣ Kelly公式智能应用

#### Kelly公式回顾

```
f* = (p × b - q) / b

其中:
- p = 胜率
- q = 败率 (1 - p)
- b = 盈亏比 (avg_win / avg_loss)
- f* = 最优仓位比例
```

#### 智能推算逻辑

**当用户没有提供历史数据时，系统会:**

1. **推算胜率** - 根据五维度综合评分
   - 综合得分 +0.6 → 胜率 65%
   - 综合得分  0.0 → 胜率 50%
   - 综合得分 -0.6 → 胜率 35%

2. **推算盈亏比** - 根据市场状态
   - 牛市: 平均盈利8%，平均亏损4%
   - 震荡市: 平均盈利6%，平均亏损5%
   - 熊市: 平均盈利5%，平均亏损6%

3. **Kelly折扣系数** - 根据市场状态和情绪
   - 牛市初期: 1.0x (Full Kelly)
   - 牛市中期: 0.5x (Half Kelly)
   - 牛市末期: 0.0x (不加杠杆)
   - 震荡市: 0.25x (Quarter Kelly)
   - 熊市末期: 0.5x (Half Kelly)
   - 其他熊市: 0.0x (不加杠杆)

4. **情绪过热惩罚**
   - 如果情绪得分 > 0.8，杠杆再打折50%

### 3️⃣ 市场状态映射

系统自动识别8种市场状态，并给出对应的仓位建议：

| 市场状态 | 综合得分范围 | 仓位区间 | 策略 |
|---------|------------|---------|------|
| 牛市初期 | > 0.6 (且估值低) | 75%-85% | 积极做多，分批建仓 |
| 牛市中期 | > 0.6 (且估值正常) | 65%-75% | 持股为主，逢低加仓 |
| 牛市末期 | > 0.6 (但估值高) | 25%-35% | 逐步减仓，落袋为安 |
| 上行震荡 | 0.3 ~ 0.6 | 55%-65% | 标准配置，高抛低吸 |
| 横盘震荡 | -0.3 ~ 0.3 | 45%-55% | 观望为主，等待方向 |
| 下行震荡 | -0.6 ~ -0.3 | 30%-40% | 轻仓观望，严格止损 |
| 熊市中期 | < -0.6 | 15%-25% | 空仓为主，等待企稳 |
| 熊市末期 | < -0.6 (但估值低) | 35%-45% | 分批建仓，价值布局 |

---

## 快速开始

### 🚀 基础使用

#### 1. 分析上证指数（默认）

```bash
python scripts/leverage_management/run_leverage_strategy.py
```

#### 2. 分析沪深300

```bash
python scripts/leverage_management/run_leverage_strategy.py --index hs300
```

#### 3. 提供历史胜率数据

```bash
python scripts/leverage_management/run_leverage_strategy.py \
    --index hs300 \
    --win-rate 0.58 \
    --avg-win 0.08 \
    --avg-loss 0.05
```

#### 4. 简化输出（只显示核心建议）

```bash
python scripts/leverage_management/run_leverage_strategy.py --no-detailed
```

### 📋 支持的指数

| 代码 | 指数名称 | 说明 |
|------|---------|------|
| `sz` | 上证指数 | 默认选项 |
| `hs300` | 沪深300 | 大盘蓝筹 |
| `cyb` | 创业板指 | 成长股 |
| `kc50` | 科创50 | 科技股 |

### 📊 输出示例

```
================================================================================
  杠杆策略分析报告 - 上证指数
  生成时间: 2025-10-27 22:34:34
================================================================================

【市场状态】
  状态: 上行震荡 (震荡向上，多头占优)
  置信度: 72.0%

【五维度评分】
  综合评分: 0.30 😐 (中性)

  各维度详情:
    👍 估值: +0.40 (良好) - 低估，安全边际高
    👍 政策: +0.16 (良好) - 政策宽松，资金充裕
    👍 情绪: +0.27 (良好) - 市场情绪乐观，参与度高
    👍 技术: +0.39 (良好) - 趋势强劲，技术形态良好
    👍 资金: +0.24 (良好) - 主力资金流入，机构加仓

【Kelly公式分析】
  估算胜率: 57.5%
  估算盈亏比: 6.0% / 5.0%
  Full Kelly: 22.01%
  Kelly折扣系数: 0.25x (震荡市，谨慎使用Quarter Kelly)
  推荐Kelly仓位: 5.50%

【综合建议】
  操作方向: 📈 偏多，标准配置
  杠杆建议: 可适度加杠杆 (杠杆=1.06x)
  说明: 市场环境一般，可小幅加杠杆，但需严格止损

【实战操作指导】
  建仓策略: 分2批建仓：第一批60%，第二批40%
  建仓时机: 第一批立即建仓，第二批等待确认趋势后加仓
  止损策略: 止损位：-6%（震荡市中等止损）
  止盈策略: 分批止盈：+20%减仓1/2，+35%全部清仓

  加仓条件:
    • 突破关键压力位时加仓
    • 估值回落至安全区域时加仓

  减仓条件:
    • 无明确减仓信号
================================================================================
```

---

## 五维度评分

### 🧮 评分算法

#### 1. 估值维度 (25%权重)

**数据来源**: `ValuationAnalyzer`
- PE/PB历史分位数
- 10年历史估值对比

**评分规则**:
```python
score = (0.5 - percentile) * 2

# 例子:
# 20%分位 → score = +0.6 (低估)
# 50%分位 → score = 0 (合理)
# 80%分位 → score = -0.6 (高估)
```

**解读**:
- `+0.5 ~ +1.0`: 极度低估，安全边际极高
- `+0.2 ~ +0.5`: 低估，安全边际高
- `-0.2 ~ +0.2`: 估值合理
- `-0.5 ~ -0.2`: 高估，泡沫风险
- `-1.0 ~ -0.5`: 极度高估，泡沫风险极高

#### 2. 政策维度 (20%权重)

**数据来源**:
- 北向资金 (60%)
- 融资融券 (40%)

**评分规则**:
```python
# 北向资金评分
capital_flow_score = (5日流入/500 * 0.6 + 20日流入/1500 * 0.4)

# 融资融券评分
leverage_score = 融资余额变化率 / 3% * 0.8

# 综合
policy_score = capital_flow_score * 0.6 + leverage_score * 0.4
```

**解读**:
- `> +0.4`: 政策宽松，资金充裕
- `0 ~ +0.4`: 政策中性偏宽松
- `-0.4 ~ 0`: 政策中性偏紧
- `< -0.4`: 政策收紧，资金撤离

#### 3. 情绪维度 (15%权重)

**数据来源**:
- 涨跌停数量 (40%)
- 市场宽度 (30%)
- 杠杆资金活跃度 (30%)

**评分规则**:
```python
# 涨跌停情绪
sentiment_score = (涨停 - 跌停) / 100

# 市场宽度
breadth_score = (上涨股票占比 - 0.5) * 2

# 综合
emotion_score = sentiment * 0.4 + breadth * 0.3 + leverage * 0.3
```

**解读**:
- `> +0.8`: ⚠️ 情绪过热，警惕回调
- `+0.4 ~ +0.8`: 市场情绪乐观，参与度高
- `-0.4 ~ +0.4`: 情绪中性
- `< -0.4`: 市场情绪低迷，恐慌抛售

#### 4. 技术维度 (20%权重)

**数据来源**:
- 均线趋势 (35%)
- 价格动量 (25%)
- 技术形态 (MACD/RSI) (20%)
- 趋势斜率 (20%)

**评分规则**:
```python
# 均线趋势
if 完美多头排列:
    trend_score = 1.0
elif 多头排列:
    trend_score = 0.6
# ... 类似逻辑

# 综合
technical_score = trend * 0.35 + price_change * 0.25 +
                  technical * 0.20 + slope * 0.20
```

**解读**:
- `> +0.5`: 趋势强劲，技术形态良好
- `0 ~ +0.5`: 趋势偏强
- `-0.5 ~ 0`: 趋势偏弱
- `< -0.5`: 趋势破位，技术形态恶化

#### 5. 资金维度 (20%权重)

**数据来源**:
- 主力资金 (40%)
- 机构行为 (30%)
- 成交量 (30%)

**评分规则**:
```python
# 主力资金
main_fund_score = (今日流入/200 * 0.4 + 5日流入/500 * 0.6)

# 机构行为
institution_score = (机构买入 - 机构卖出) / (总数)

# 综合
capital_score = main_fund * 0.4 + institution * 0.3 + volume * 0.3
```

**解读**:
- `> +0.4`: 主力资金流入，机构加仓
- `0 ~ +0.4`: 资金流入偏正
- `-0.4 ~ 0`: 资金流出偏负
- `< -0.4`: 主力资金流出，机构减仓

---

## Kelly公式应用

### 📐 Kelly公式原理

#### 基础公式

```
f* = (p × b - q) / b

其中:
- f* = 最优仓位比例
- p = 胜率
- q = 败率 = 1 - p
- b = 盈亏比 = avg_win / avg_loss
```

#### 推导过程

假设:
- 每次交易的盈利是 `w` (win)
- 每次交易的亏损是 `l` (loss)
- 初始资金是 `C0`
- 每次投入比例是 `f`

经过N次交易后，期望资金增长率最大化的仓位 `f*` 就是Kelly公式。

### 🎯 系统实现

#### 1. 有历史数据时

**直接使用用户提供的数据**:

```python
kelly_result = calculate_leverage_recommendations(
    win_rate=0.55,      # 用户提供
    avg_win=0.08,       # 用户提供
    avg_loss=0.05       # 用户提供
)
# Full Kelly = (0.55 * 1.6 - 0.45) / 1.6 = 0.2688 (约27%)
```

#### 2. 无历史数据时

**系统智能推算**:

```python
# 步骤1: 根据五维度评分推算胜率
overall_score = 0.30  # 综合得分
estimated_win_rate = 0.5 + overall_score * 0.25
                   = 0.5 + 0.30 * 0.25
                   = 0.575 (57.5%)

# 步骤2: 根据市场状态推算盈亏比
market_state = '上行震荡'
if '震荡' in market_state:
    estimated_avg_win = 0.06  # 6%
    estimated_avg_loss = 0.05  # 5%

# 步骤3: 计算Kelly
full_kelly = kelly_criterion(0.575, 0.06, 0.05)
           = (0.575 * 1.2 - 0.425) / 1.2
           = 0.2208 (22.08%)

# 步骤4: 应用Kelly折扣系数
if market_state == '上行震荡':
    multiplier = 0.25  # Quarter Kelly

recommended_kelly = full_kelly * multiplier
                  = 0.2208 * 0.25
                  = 0.0552 (5.52%)

# 步骤5: 转换为杠杆倍数
recommended_leverage = 1.0 + recommended_kelly
                     = 1.0 + 0.0552
                     = 1.055x
```

### 🛡️ Kelly折扣系数设计

**为什么不用Full Kelly?**

根据《杠杆与风险管理指南》:
- Full Kelly假设参数完全准确，但实际交易中参数是估计值
- 过度杠杆会导致破产风险指数上升
- Quarter Kelly通常是最优选择

**折扣系数逻辑**:

| 市场状态 | Kelly折扣 | 理由 |
|---------|----------|------|
| 牛市初期 | 1.0x (Full) | 底部启动，可以大胆加杠杆 |
| 牛市中期 | 0.5x (Half) | 主升浪，控制风险 |
| 牛市末期 | 0.0x | 风险极高，不加杠杆 |
| 上行震荡 | 0.25x (Quarter) | 谨慎操作 |
| 横盘震荡 | 0.0x | 方向不明，不加杠杆 |
| 下行震荡 | 0.0x | 下跌趋势，不加杠杆 |
| 熊市中期 | 0.0x | 熊市不加杠杆 |
| 熊市末期 | 0.5x (Half) | 底部区域，可适度加杠杆 |

**情绪过热惩罚**:
```python
if sentiment_score > 0.8:
    multiplier *= 0.5  # 再打折50%
```

---

## 实战案例

### 📌 案例1: 牛市初期（模拟924行情）

**假设市场数据**:

```python
五维度评分:
- 估值: +0.70 (极度低估，PE处于10年10%分位)
- 政策: +0.60 (北向资金大幅流入，政策宽松信号)
- 情绪: -0.40 (市场恐慌，但这是反向指标)
- 技术: +0.30 (开始企稳，均线粘合)
- 资金: +0.50 (主力资金开始进场)

综合得分: +0.54
市场状态: 牛市初期
```

**Kelly分析**:

```python
推算胜率: 0.5 + 0.54 * 0.25 = 0.635 (63.5%)
推算盈亏比: 8% / 4% = 2.0 (牛市初期)

Full Kelly: (0.635 * 2.0 - 0.365) / 2.0 = 0.4525 (45.25%)
Kelly折扣: 1.0x (牛市初期可Full Kelly)
推荐Kelly: 45.25%

建议杠杆: 1.45x
```

**综合建议**:

```
操作方向: 🚀 积极做多
杠杆建议: 可大胆加杠杆 (杠杆=1.45x)

实战指导:
- 建仓策略: 分3批建仓 (50% + 30% + 20%)
- 止损策略: -8% (牛市初期容忍度高)
- 止盈策略: +15%减1/3, +25%减1/3, +35%清仓
- 风险提示: 底部反转需要确认，等待2-3根阳线确认趋势
```

**实际类比**: 2024年9月24日前后，政策密集出台，市场处于极度低估区域，这是典型的牛市初期加杠杆时机。

---

### 📌 案例2: 牛市末期（警惕回调）

**假设市场数据**:

```python
五维度评分:
- 估值: -0.65 (极度高估，PE处于10年90%分位)
- 政策: -0.30 (北向资金流出，政策收紧信号)
- 情绪: +0.85 (市场极度亢奋，涨停家数爆表) ⚠️
- 技术: +0.40 (技术上仍然强势)
- 资金: +0.30 (主力资金分歧)

综合得分: +0.12
市场状态: 牛市末期
```

**Kelly分析**:

```python
推算胜率: 0.5 + 0.12 * 0.25 = 0.53 (53%)
推算盈亏比: 5% / 6% = 0.833 (牛市末期盈亏比恶化)

Full Kelly: (0.53 * 0.833 - 0.47) / 0.833 = 0.0277 (2.77%)
Kelly折扣: 0.0x (牛市末期不加杠杆)
情绪过热: sentiment > 0.8, 额外惩罚

推荐Kelly: 0%
建议杠杆: 1.0x (不加杠杆)
```

**综合建议**:

```
操作方向: 😐 中性，逐步减仓
杠杆建议: 不建议加杠杆 (杠杆=1.0x)

实战指导:
- 建仓策略: 不建议新建仓
- 已有仓位: 分批减仓，落袋为安
- 止损策略: 严格止损-5%
- 风险提示:
  ⚠️ 估值过高，泡沫风险
  ⚠️ 市场情绪过热，警惕回调风险
  ⚠️ 市场处于不利阶段，建议降低杠杆
```

**实际类比**: 2015年6月、2021年2月，市场情绪极度亢奋，估值高企，这些时期都是牛市末期，应该降低杠杆甚至空仓。

---

### 📌 案例3: 震荡市（Quarter Kelly）

**假设市场数据**:

```python
五维度评分:
- 估值: +0.30 (估值合理偏低)
- 政策: +0.15 (政策中性偏宽松)
- 情绪: +0.25 (情绪正常偏乐观)
- 技术: +0.35 (震荡向上)
- 资金: +0.20 (资金流入一般)

综合得分: +0.25
市场状态: 上行震荡
```

**Kelly分析**:

```python
推算胜率: 0.5 + 0.25 * 0.25 = 0.5625 (56.25%)
推算盈亏比: 6% / 5% = 1.2 (震荡市)

Full Kelly: (0.5625 * 1.2 - 0.4375) / 1.2 = 0.1979 (19.79%)
Kelly折扣: 0.25x (Quarter Kelly，谨慎操作)
推荐Kelly: 19.79% * 0.25 = 4.95%

建议杠杆: 1.05x
```

**综合建议**:

```
操作方向: 📈 偏多，标准配置
杠杆建议: 可适度加杠杆 (杠杆=1.05x)

实战指导:
- 建仓策略: 分2批建仓 (60% + 40%)
- 止损策略: -6% (震荡市中等止损)
- 止盈策略: +20%减1/2, +35%清仓
- 操作节奏: 高抛低吸，不追高不杀跌
```

**实际类比**: 大部分时间市场都处于震荡状态，这时应该谨慎使用Quarter Kelly，控制风险。

---

## 注意事项

### ⚠️ 风险警告

1. **杠杆交易风险极高**
   - 杠杆放大收益的同时也放大亏损
   - 即使是Quarter Kelly也可能导致重大亏损
   - 建议新手从无杠杆开始，逐步熟悉

2. **模型依赖历史数据**
   - Kelly公式假设未来与历史相似
   - 如果市场环境发生根本变化（如黑天鹅事件），模型可能失效
   - 建议结合基本面分析和宏观判断

3. **情绪过热是最大风险**
   - 当市场情绪得分 > 0.8时，系统会自动降低杠杆
   - 但市场情绪可以持续很久，不要逆势做空
   - 建议在情绪过热时逐步减仓，而不是反向加杠杆

4. **止损纪律最重要**
   - 任何杠杆策略都必须配合严格的止损
   - 建议止损位在-5%到-8%之间
   - 一旦触发止损，立即执行，不要犹豫

### 💡 最佳实践

1. **分批建仓**
   - 永远不要一次性满仓
   - 根据系统建议分2-3批建仓
   - 每批之间间隔3-5天，等待市场确认

2. **动态调整**
   - 每周运行一次系统分析
   - 根据市场状态变化调整杠杆
   - 牛市末期要果断降低杠杆

3. **记录交易日志**
   - 记录每次交易的理由和结果
   - 统计实际胜率和盈亏比
   - 将实际数据输入系统，获得更准确的建议

4. **心理准备**
   - 杠杆交易心理压力大
   - 建议从小额资金开始练习
   - 不要用生活必需资金做杠杆交易

### 🛠️ 系统特性

**当前版本 (v1.1) 已接入真实市场数据**

- ✅ 框架完整，逻辑正确
- ✅ 五维度评分、Kelly计算、市场状态识别全部实现
- ✅ **已接入真实市场数据** (通过 akshare + EnhancedDataProvider)
- ✅ 支持13维度实时数据采集
- ⚠️ 部分指标可能因API限制偶尔获取失败（已做降级处理）

**数据来源**:
- 行情数据：akshare (腾讯/新浪接口)
- 估值数据：PE/PB历史分位数
- 资金数据：北向资金、主力资金、融资融券
- 情绪数据：涨跌停统计、市场宽度
- 技术数据：均线、MACD、RSI等

**未来版本计划**:

- [x] ~~v1.1: 接入真实市场数据 (akshare/tushare)~~ ✅ **已完成**
- [ ] v1.2: 添加历史回测功能
- [ ] v1.3: 支持个股分析（目前仅支持指数）
- [ ] v1.4: 添加自动化交易接口
- [ ] v2.0: Web界面 + 实时监控

---

## 附录

### 📚 相关文档

- [杠杆与风险管理指南.md](./杠杆与风险管理指南.md) - 理论基础
- [投资纪律手册.md](./投资纪律手册.md) - 仓位管理规则
- [INVESTMENT_STRATEGY.md](../design/INVESTMENT_STRATEGY.md) - 投资策略设计

### 🔗 相关模块

**核心引擎**:
- `src/analyzers/macro/leverage/leverage_strategy_engine.py`
- `src/analyzers/macro/leverage/kelly_calculator.py`

**分析组件**:
- `src/analyzers/position/core/market_state_detector.py` - 市场状态检测
- `src/analyzers/position/core/valuation_analyzer.py` - 估值分析
- `src/analyzers/position/analyzers/market_structure/sentiment_index.py` - 情绪分析
- `russ_trading_strategy/dynamic_position_manager.py` - 仓位管理

**CLI入口**:
- `scripts/leverage_management/run_leverage_strategy.py`

### 📞 联系方式

如有问题或建议:
- 提交Issue: [GitHub Issues](https://github.com/your-repo/issues)
- 项目主页: [README.md](../../README.md)

---

**最后更新**: 2025-10-27
**文档版本**: v1.0
**维护者**: Russ Investment Research Team
