# 综合资产分析系统

## 📊 功能概述

每日自动分析**7大资产**(四大科技指数 + 沪深300 + 黄金 + 比特币),提供**11大维度**的综合分析报告。

### 分析对象

#### 🚀 四大科技指数
- 🇨🇳 **创业板指** - 中国创新型企业代表
- 🇨🇳 **科创50** - 中国科创板龙头
- 🇭🇰 **恒生科技** - 香港科技股指数
- 🇺🇸 **纳斯达克** - 全球科技股风向标

#### 📊 宽基指数
- 🇨🇳 **沪深300** - A股核心资产

#### 💰 大宗商品
- 🌟 **黄金** - 传统避险资产

#### ₿ 加密货币
- 🚀 **比特币** - 数字黄金

### 分析维度 (11大维度全覆盖)

1. **历史点位分析** ⭐⭐⭐
   - 查找相似历史点位
   - 计算未来20日/60日涨跌概率
   - 平均收益/收益中位数/置信度

2. **技术面分析** ⭐⭐⭐
   - MACD金叉/死叉
   - RSI超买/超卖
   - KDJ指标(K/D/J值,金叉/死叉)
   - 布林带(上中下轨,当前位置)
   - ATR波动率(真实波幅)
   - DMI/ADX趋势强度分析
   - 均线偏离度(MA5/MA20/MA60)
   - 背离信号检测(MACD/RSI/量价背离)

3. **资金面分析** ⭐⭐
   - A股: 北向资金(外资流向)
   - 港股: 南向资金(内地资金流向)
   - 资金流向状态/情绪评分
   - 注: 黄金、比特币无资金面分析

4. **估值分析** ⭐
   - PE/PB分位数(待集成数据源)

5. **市场情绪** ⭐
   - 涨停/跌停数量(仅A股)
   - 市场热度判断

6. **风险评估** ⭐⭐⭐
   - 综合风险评分(0-1)
   - 风险等级(低/中/高/极高)
   - 具体风险因素列表

7. **综合判断** ⭐⭐⭐
   - 方向判断(看多/中性/看空)
   - 建议仓位(20%-80%)
   - 操作策略建议
   - 组合策略匹配(牛市/熊市/抄底/逃顶)

8. **成交量分析** ⭐⭐ 🆕
   - OBV能量潮趋势
   - 量比分析(当前成交量/5日均量)
   - 量价关系(价涨量增/价跌量缩等)
   - 成交量异常检测

9. **支撑压力位** ⭐⭐ 🆕
   - 轴心点位(Pivot Points)
   - 斐波那契回撤位
   - 历史高低点S/R位
   - 当前位置相对分析

10. **市场宽度分析** ⭐⭐ 🆕
    - 创新高/新低股票数量(仅A股)
    - 市场强度评分
    - 板块轮动信号
    - 市场广度解读

11. **恐慌指数** ⭐⭐⭐ 🆕
    - 美股: VIX恐慌指数
    - A股: CNVI自定义波动率指数(基于历史波动率、价格区间波动、成交量波动)
    - 港股: VHSI波动率指数(失败时fallback到HKVI自定义指数)
    - 恐慌等级判断(极度恐慌/恐慌上升/正常区间/过度乐观)
    - 历史分位数分析
    - 交易信号生成

---

## 🚀 快速开始

### 1. 运行分析(控制台输出)

```bash
cd /Users/russ/PycharmProjects/stock-analysis
python scripts/comprehensive_asset_analysis/run_asset_analysis.py
```

**输出示例**:
```
================================================================================
综合资产分析报告
分析对象: 四大科技指数 + 沪深300 + 黄金 + 比特币
分析时间: 2025-10-15 15:30:00
================================================================================

【四大科技指数】
================================================================================

────────────────────────────────────────────────────────────────────────────────
【创业板指】
────────────────────────────────────────────────────────────────────────────────

【当前点位】
  最新价格: 2955.98
  涨跌幅: -3.99%
  数据日期: 2025-10-15

【历史点位分析】
  相似点位: 96 个
  未来20日:
    上涨概率: 51.1% (下跌概率: 48.9%)
    平均收益: +1.10%
    置信度: 60.8%

【技术面分析】
  MACD: 死叉🔴
  RSI: 41.4 😊
  KDJ: K=22.3, D=38.0, J=-9.3 死叉🔴 ✅
  布林带: 上=3315.30, 中=3100.76, 下=2886.21
         当前位置: 16% ✅ 接近下轨
  ...

【风险评估】
  综合风险: 0.00 (低风险🟢)

【综合判断】
  方向判断: 中性偏多⚖️
  建议仓位: 50-60%
  操作策略:
    • 历史概率支持,可以配置
    • ✅ 低风险,可以持有

────────────────────────────────────────────────────────────────────────────────

【大宗商品】
================================================================================

────────────────────────────────────────────────────────────────────────────────
【黄金】
────────────────────────────────────────────────────────────────────────────────
...

【加密货币】
================================================================================

────────────────────────────────────────────────────────────────────────────────
【比特币】
────────────────────────────────────────────────────────────────────────────────
...
```

### 2. 发送邮件报告

```bash
python scripts/comprehensive_asset_analysis/run_asset_analysis.py --email
```

**邮件将发送到**: 配置文件中的收件人列表(支持多个收件人)

**邮件效果**:
- ✅ 精美HTML格式
- ✅ 按类别分组展示(科技指数/宽基指数/商品/加密货币)
- ✅ 7大资产对比卡片
- ✅ 风险评估高亮
- ✅ 组合策略匹配提示
- ✅ 移动端友好
- ✅ 支持多个收件人同时发送

### 3. 保存到文件

**文本格式**:
```bash
python scripts/comprehensive_asset_analysis/run_asset_analysis.py --save reports/asset_$(date +%Y%m%d).txt
```

**Markdown格式** 🆕:
```bash
python scripts/comprehensive_asset_analysis/run_asset_analysis.py --format markdown --save reports/asset_$(date +%Y%m%d).md
```

Markdown格式特点:
- ✅ 支持GitHub/GitLab渲染
- ✅ 表格展示更清晰
- ✅ 分级标题结构化
- ✅ 适合生成文档

---

## ⚙️ 配置邮件发送

### 步骤1: 复制配置文件模板

```bash
cp config/email_config.yaml.template config/email_config.yaml
```

### 步骤2: 获取QQ邮箱授权码

1. 登录QQ邮箱 (mail.qq.com)
2. 进入**设置** → **账户**
3. 找到 **POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务**
4. 开启 **POP3/SMTP服务** 或 **IMAP/SMTP服务**
5. 点击**生成授权码**，按提示发送短信
6. 复制生成的授权码(16位字母)

### 步骤3: 编辑配置文件

```yaml
# config/email_config.yaml
smtp:
  server: smtp.qq.com
  port: 465

sender:
  email: your_email@qq.com       # 你的QQ邮箱
  password: abcd1234efgh5678      # 填入刚才的授权码
  name: 综合资产分析系统

recipients:
  - 1264947688@qq.com             # 收件人1
  - 1194714620@qq.com             # 收件人2(可选)
  - 2645826123@qq.com             # 收件人3(可选)
```

### 步骤4: 测试邮件发送

```bash
python scripts/comprehensive_asset_analysis/run_asset_analysis.py --email
```

如果看到 `✅ 邮件发送成功`，说明配置正确！

---

## ⏰ 每日自动执行

### 方式1: crontab定时任务(推荐)

```bash
# 编辑crontab
crontab -e

# 添加以下行(每天下午3点执行,美股开盘前)
0 15 * * * cd /Users/russ/PycharmProjects/stock-analysis && /usr/bin/python3 scripts/comprehensive_asset_analysis/run_asset_analysis.py --email >> logs/asset_analysis.log 2>&1
```

**执行时间建议**:
- 🇨🇳 A股: 15:30后(收盘后)
- 🇭🇰 港股: 16:30后(收盘后)
- 🇺🇸 美股: 次日早上6:00(美东时间16:00收盘后)
- 💰 黄金: 24小时交易
- ₿ 比特币: 24小时交易

**综合建议**: 每天**下午3点**或**晚上22点**执行

### 方式2: 使用提供的cron脚本

```bash
# 查看cron脚本
cat scripts/comprehensive_asset_analysis/setup_daily_cron.sh

# 执行安装
bash scripts/comprehensive_asset_analysis/setup_daily_cron.sh
```

---

## 📖 策略解读

### 历史点位分析

**原理**: 找到历史上价格相近的时期，统计后续涨跌情况

**示例**:
```
当前价格: 2955
相似点位: 96个 (±5%区间内)
20日上涨概率: 51% → 历史上51%的情况后续上涨
平均收益: +1.1% → 平均涨幅1.1%
置信度: 61% → 样本量中等，可参考
```

**如何使用**:
- 上涨概率 > 60% → 偏多信号
- 上涨概率 < 40% → 偏空信号
- 置信度 > 70% → 结果可靠
- 置信度 < 50% → 参考价值有限

### 风险评分

**评分范围**: 0.0 - 1.0 (越高越危险)

**评分构成**:
- 30% 历史概率风险
- 30% 技术面风险(MACD背离/RSI超买)
- 20% 资金面风险(资金流出,仅指数)
- 20% 市场情绪风险(涨停过多,仅A股)

**风险等级**:
- < 0.3 → 🟢 低风险
- 0.3-0.5 → 🟡 中风险
- 0.5-0.7 → 🟠 高风险
- > 0.7 → 🔴 极高风险

### 组合策略匹配

#### 牛市确认组合(5/5项)
```
✅ 历史概率 > 60%
✅ 风险评分 < 0.4
✅ MACD金叉
✅ RSI健康(30-70)
✅ 资金流入(仅指数)

→ 满足4项以上 → 强烈看多,可重仓70-80%
```

#### 熊市确认组合(5/5项)
```
🔴 历史概率 < 40%
🔴 风险评分 > 0.6
🔴 MACD死叉或顶背离
🔴 RSI超买(>70)
🔴 资金流出(仅指数)

→ 满足3项以上 → 熊市特征,减仓至20-30%
```

#### 抄底组合(3/3项)
```
✅ RSI < 30 (严重超卖)
✅ 资金开始流入(仅指数)
✅ 历史概率 > 50%

→ 满足2-3项 → 可能是底部,分批建仓
```

#### 逃顶组合(4/4项)
```
🔴 MACD顶背离
🔴 RSI > 80
🔴 风险评分 > 0.7
🔴 资金流出(仅指数)

→ 满足2项以上 → 顶部特征明显,强烈建议减仓
```

---

## 💡 资产特点说明

### 黄金分析特点
- ✅ 历史点位分析
- ✅ 技术面分析(MACD/RSI/KDJ/布林带/ATR/DMI/均线/背离)
- ✅ 风险评估
- ✅ 综合判断
- ❌ 无资金面分析(全球市场)
- ❌ 无估值分析
- ❌ 无市场情绪分析
- 💡 **关注要点**: 地缘政治、通胀预期、美元走势、避险情绪

### 比特币分析特点
- ✅ 历史点位分析
- ✅ 技术面分析(MACD/RSI/KDJ/布林带/ATR/DMI/均线/背离)
- ✅ 风险评估
- ✅ 综合判断
- ❌ 无资金面分析(全球市场)
- ❌ 无估值分析
- ❌ 无市场情绪分析
- 💡 **关注要点**: 波动率极高、控制仓位、监管政策、机构动向

### 沪深300分析特点
- ✅ 全维度分析(与四大科技指数相同)
- 💡 **关注要点**: 作为A股核心资产代表,反映整体市场趋势

---

## 🔧 高级用法

### 只分析特定资产

修改 `asset_reporter.py` 中的 `COMPREHENSIVE_ASSETS` 字典：

```python
# 只分析黄金和比特币
COMPREHENSIVE_ASSETS = {
    'GOLD': {
        'type': 'commodity',
        'market': 'US',
        'name': '黄金',
        'code': 'GOLD',
        'category': 'commodity'
    },
    'BTC': {
        'type': 'crypto',
        'market': 'US',
        'name': '比特币',
        'code': 'BTC',
        'category': 'crypto'
    }
}
```

### 添加新资产

在 `COMPREHENSIVE_ASSETS` 中添加新条目：

```python
# 添加沪深300
'CSI300': {
    'type': 'index',
    'market': 'CN',
    'name': '沪深300',
    'code': 'CSI300',
    'category': 'broad_index'
},

# 添加白银
'SILVER': {
    'type': 'commodity',
    'market': 'US',
    'name': '白银',
    'code': 'SILVER',
    'category': 'commodity'
},

# 添加以太坊
'ETH': {
    'type': 'crypto',
    'market': 'US',
    'name': '以太坊',
    'code': 'ETH',
    'category': 'crypto'
}
```

### 调整容差范围

历史点位匹配的容差默认是 ±5%，可在代码中调整：

```python
# asset_reporter.py 第283行
tolerance = 0.05  # 改为0.03 = ±3%
```

### 自定义风险评分权重

在 `_calculate_risk_score` 方法中调整各维度权重。

---

## 📊 数据来源

- **A股数据**: Akshare (腾讯+新浪双核心)
- **港股数据**: yfinance
- **美股数据**: yfinance
- **黄金数据**: yfinance (纽约黄金期货 GC=F)
- **比特币数据**: yfinance (BTC-USD)
- **北向资金**: Akshare
- **南向资金**: Akshare

---

## ❓ 常见问题

### Q1: 邮件发送失败?

**检查清单**:
1. ✅ `config/email_config.yaml` 是否存在
2. ✅ 邮箱地址和授权码是否正确
3. ✅ 授权码是否包含空格(应该去掉)
4. ✅ 网络是否正常

### Q2: 分析速度慢?

正常情况下约需2-3分钟(比四大科技指数慢,因为增加了3个资产)。慢的原因:
- 数据获取需要时间(美股/港股/加密货币需要访问外网)
- 背离分析需要计算大量指标
- 7个资产需要逐个分析

**优化建议**: 使用缓存,第二次运行会快很多

### Q3: 黄金/比特币数据获取失败?

可能原因:
1. yfinance服务不稳定
2. 网络连接问题
3. 代理设置

**解决方案**:
```bash
# 设置代理(如需要)
export http_proxy=http://127.0.0.1:7890
export https_proxy=http://127.0.0.1:7890

# 重新运行
python scripts/comprehensive_asset_analysis/run_asset_analysis.py
```

### Q4: 比特币波动率显示很高?

这是正常的！比特币的波动率通常是传统资产的数倍:
- 传统股票: 年化波动率 15-30%
- 黄金: 年化波动率 10-20%
- **比特币: 年化波动率 50-100%+**

**建议**: 控制仓位,注意风险管理

### Q5: 如何理解"置信度"?

置信度综合了两个因素:
1. 样本量 (相似点位数量)
2. 一致性 (上涨/下跌的比例)

**示例**:
- 样本20个,上涨15个 → 置信度约60%
- 样本100个,上涨80个 → 置信度约90%

### Q6: 黄金显示100%上涨概率?

这可能是因为:
1. 黄金处于历史低位,相似点位后续都上涨了
2. 或黄金处于历史高位,相似点位非常少

**注意**: 即使概率100%,也要结合技术面(如MACD背离)综合判断！

### Q7: CNVI和HKVI是什么?

**CNVI** (Chinese Market Volatility Index) - A股自定义波动率恐慌指数
**HKVI** (Hong Kong Market Volatility Index) - 港股自定义波动率恐慌指数

**为什么需要自定义指数?**
- A股市场没有官方恐慌指数(不像美股有VIX)
- 港股VHSI数据源不稳定(Yahoo Finance经常404)
- 自定义指数基于实际历史数据计算,更贴合市场实际波动

**计算方法**:
- 40% 历史波动率(20日滚动标准差,年化)
- 30% 价格区间波动(日内高低价波动)
- 30% 成交量波动(成交量放大/缩小)

**阈值标准**(与VIX对齐):
- CNVI/HKVI > 30: 极度恐慌 😱 → 可能是抄底良机
- CNVI/HKVI 25-30: 恐慌上升 ⚠️ → 控制仓位,等待企稳
- CNVI/HKVI 15-25: 正常区间 😊 → 正常操作
- CNVI/HKVI < 15: 过度乐观 😌 → 警惕调整风险

### Q8: 为什么港股用HKVI而不是VHSI?

系统会**优先尝试VHSI**(港股官方波动率指数),但如果:
- Yahoo Finance数据获取失败(404错误)
- VHSI停止更新
- 网络问题

系统会**自动fallback到HKVI**,确保分析不中断。日志会显示:
```
WARNING: VHSI数据获取失败,使用港股自定义波动率指数HKVI
```

---

## 🆚 与四大科技指数系统的区别

| 特性 | 四大科技指数 | 综合资产分析 |
|------|------------|------------|
| 分析对象 | 4个科技指数 | 7个资产(4科技指数+沪深300+黄金+比特币) |
| 资产类别 | 仅股指 | 股指+商品+加密货币 |
| 资金面分析 | 全部支持 | 仅指数支持 |
| 特殊提示 | 无 | 黄金/比特币有避险/高波动提示 |
| 报告分组 | 无分组 | 按类别分组展示 |
| 使用场景 | 科技股投资 | 跨资产配置、避险策略 |

---

## 📝 更新日志

### v1.2.0 (2025-10-15) 🆕
- ✨ **新增**: A股自定义恐慌指数CNVI(基于历史波动率、价格区间波动、成交量波动)
- ✨ **新增**: 港股自定义恐慌指数HKVI(VHSI数据不可用时自动fallback)
- 🐛 **修复**: 邮件发送支持多个收件人(之前只能发送给1个收件人)
- 📊 **优化**: 恐慌指数阈值对齐VIX标准(>30极度恐慌, 25-30恐慌上升, 15-25正常, <15过度乐观)
- ✅ A股所有资产(创业板指、科创50、沪深300)现均有CNVI指数
- ✅ 港股恒生科技智能切换VHSI/HKVI

### v1.1.0 (2025-10-15)
- ✨ **重大更新**: 从7维度扩展到11维度分析
- 🆕 **新增维度8**: 成交量分析(OBV/量比/量价关系)
- 🆕 **新增维度9**: 支撑压力位(轴心点/斐波那契/历史高低点)
- 🆕 **新增维度10**: 市场宽度分析(创新高新低统计,仅A股)
- 🆕 **新增维度11**: 恐慌指数(VIX美股/VHSI港股)
- ✅ 支持Markdown格式输出
- ✅ 控制台输出格式优化
- ✅ 报告内容全面升级

### v1.0.0 (2025-10-15)
- ✨ 初始版本发布
- ✅ 支持7大资产综合分析
- ✅ 7大维度完整分析
- ✅ 组合策略匹配
- ✅ 邮件发送功能
- ✅ HTML精美报告
- ✅ 按类别分组展示
- ✅ 黄金/比特币特殊提示

---

## 🚀 扩展计划

### 待支持资产
- [ ] 白银 (SILVER)
- [ ] 原油 (OIL)
- [ ] 以太坊 (ETH)
- [ ] 恒生指数 (HSI)
- [ ] 标普500 (SPX)

### 待优化功能
- [ ] 资产相关性分析(如黄金与美元指数)
- [ ] 跨资产轮动策略
- [ ] 配置建议(股债商比例)
- [ ] 避险信号检测

---

## 🤝 贡献

由 **Claude Code** 和 **Russ** 共同开发

如有问题或建议，欢迎反馈！

---

**祝您投资顺利！📈💰₿**
