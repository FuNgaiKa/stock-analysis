# Phase 3 高级功能设计 - 市场状态智能诊断

## 调研总结 (2025-10-09)

### 📊 量化领域前沿趋势

**1. 市场状态判断核心指标**
- 情绪周期识别 (快线/慢线双指标体系)
- 牛熊周期判断 (非传统周期逻辑)
- 筹码分布分析 (主力/散户筹码结构)
- 资金流向追踪 (主力资金/大单/机构)

**2. 2025年市场特征**
- A股呈现"稳步量变上行"趋势,非传统牛熊
- 群体情绪传导速度极快(个人投资者为主)
- 新质生产力(AI/科技)成为核心驱动力
- 融资余额等杠杆指标仍是重要监测点

**3. 关键发现**
- 3大情绪指标(NHNL/PCR/NMTAP)同时提示恐慌 = 阶段性底部
- 赚钱效应/亏钱效应的正负反馈循环是情绪周期核心
- 跳出传统牛熊思维,理解"量变到质变"的渐进过程

---

## 🎯 Phase 3 核心功能规划

### 功能1: 市场状态识别 (State Detection) ⭐⭐⭐⭐⭐

**目标**: 自动识别当前市场处于什么阶段

**状态分类**:
```
├─ 牛市
│  ├─ 牛市初期 (底部启动)
│  ├─ 牛市中期 (主升浪)
│  └─ 牛市末期 (疯狂顶部)
├─ 熊市
│  ├─ 熊市初期 (高位崩盘)
│  ├─ 熊市中期 (持续阴跌)
│  └─ 熊市末期 (磨底)
├─ 震荡市
│  ├─ 上行震荡
│  ├─ 横盘震荡
│  └─ 下行震荡
└─ 转折期
   ├─ 牛转熊 (见顶信号)
   └─ 熊转牛 (见底信号)
```

**判断依据 (12维度综合评分)**:

| 维度 | 指标 | 数据源 | 权重 |
|------|------|--------|------|
| 1. 趋势 | 20/60/120日均线排列 | 价格数据 | 15% |
| 2. 涨跌幅 | 近20/60日累计涨跌幅 | 价格数据 | 10% |
| 3. 估值 | PE/PB分位数 | Phase 2已实现 | 12% |
| 4. 资金 | 北向资金流向 | Phase 2已实现 | 10% |
| 5. 情绪 | 涨跌停比例 | Phase 2已实现 | 8% |
| 6. 宽度 | 上涨家数占比 | Phase 2已实现 | 8% |
| 7. 杠杆 | 融资余额变化 | AKShare新增 | 8% |
| 8. 主力资金 | 主力净流入 | AKShare新增 | 10% |
| 9. 机构行为 | 龙虎榜/机构席位 | AKShare新增 | 5% |
| 10. 波动率 | VIX式波动率 | Phase 2已实现 | 5% |
| 11. 成交量 | 量能变化 | Phase 2已实现 | 5% |
| 12. 技术形态 | MACD/RSI背离 | Phase 2已实现 | 4% |

**算法设计**:
```python
def detect_market_state(metrics: Dict) -> Dict:
    """
    市场状态识别

    Returns:
        {
            'state': '牛市中期',
            'confidence': 0.85,
            'sub_scores': {...},
            'key_signals': ['主力持续流入', '估值合理偏低', '趋势向上'],
            'risk_alerts': ['融资余额过高', '情绪过热']
        }
    """
    # 1. 计算12维度得分
    # 2. 加权综合评分 (-1到+1)
    # 3. 状态映射
    # 4. 置信度计算
    # 5. 关键信号提取
    pass
```

---

### 功能2: 情绪周期追踪 (Sentiment Cycle) ⭐⭐⭐⭐⭐

**目标**: 量化市场情绪所处阶段,预测情绪拐点

**情绪周期模型**:
```
恐慌 → 谨慎 → 乐观 → 狂热 → 贪婪 → 恐慌
  ↑                                    ↓
  └────────── 情绪循环 ─────────────────┘
```

**核心指标**:
1. **快线指标** (灵敏,短期)
   - 涨跌停数量 (已有)
   - 龙虎榜活跃度 (新增)
   - 日内波动率 (新增)

2. **慢线指标** (稳定,中期)
   - 融资余额变化 (新增)
   - 北向资金趋势 (已有)
   - 换手率水平 (新增)

3. **极值信号** (转折点)
   - NHNL (新高新低数量对比)
   - PCR (看跌看涨期权比)
   - 恐慌指数 (自定义)

**实现方案**:
```python
class SentimentCycleTracker:
    """情绪周期追踪器"""

    def get_sentiment_phase(self) -> str:
        """获取当前情绪阶段"""
        # 恐慌/谨慎/乐观/狂热/贪婪
        pass

    def detect_sentiment_extremes(self) -> Dict:
        """检测情绪极值(买入/卖出信号)"""
        # 3大情绪指标同时提示恐慌 = 底部
        # 3大情绪指标同时提示狂热 = 顶部
        pass

    def predict_sentiment_turning_point(self) -> Dict:
        """预测情绪拐点"""
        # 快线与慢线背离 = 可能转折
        pass
```

---

### 功能3: 主力资金追踪 (Main Fund Tracking) ⭐⭐⭐⭐

**目标**: 追踪主力/机构资金动向,识别"聪明钱"行为

**数据源 (AKShare)**:
```python
# 1. 主力资金流向
ak.stock_main_fund_flow()  # 主力净流入

# 2. 大单追踪
ak.stock_fund_flow_big_deal()  # 大单流入/流出

# 3. 龙虎榜
ak.stock_lhb_detail_em()  # 龙虎榜明细
ak.stock_lhb_jgmmtj_em()  # 机构买卖统计

# 4. 机构持仓
ak.fund_portfolio_hold_em()  # 基金持仓

# 5. 融资融券
ak.stock_margin_detail_em()  # 融资融券明细
```

**分析维度**:
1. 主力资金净流入 (连续N日)
2. 大单成交占比 (主力参与度)
3. 龙虎榜机构席位 (机构态度)
4. 融资余额变化 (杠杆资金)
5. 北向资金 + 主力资金 (内外资联动)

**应用场景**:
- 主力持续流入 + 价格横盘 = 吸筹阶段
- 主力持续流出 + 价格上涨 = 出货阶段
- 机构席位增加 + 北向流入 = 强烈看多

---

### 功能4: 筹码分析 (Chip Analysis) ⭐⭐⭐

**目标**: 分析筹码结构,判断主力/散户成本分布

**数据源**:
```python
# 筹码分布
ak.stock_cyq_em(symbol="000001")  # 东方财富筹码分布

# 辅助数据
- 成交量分布
- 换手率
- 大宗交易
```

**分析指标**:
1. **筹码集中度**
   - 70%筹码集中在±10%价格区间 = 高度集中(主力控盘)
   - 筹码分散 = 散户为主

2. **获利盘/套牢盘比例**
   - 获利盘>70% = 抛压大
   - 套牢盘>70% = 反弹动力

3. **主力成本**
   - 估算主力平均成本线
   - 当前价格 vs 主力成本 (盈亏状态)

**应用**:
- 筹码低位集中 + 主力流入 = 吸筹完成,待拉升
- 筹码高位集中 + 主力流出 = 派发完成,待下跌

---

### 功能5: 行业轮动分析 (Sector Rotation) ⭐⭐⭐⭐

**目标**: 识别热点板块,捕捉行业轮动机会

**数据源**:
```python
# 行业板块
ak.stock_board_industry_hist_em()  # 行业历史行情
ak.stock_sector_fund_flow_rank()  # 板块资金流向排名
ak.stock_board_industry_cons_em()  # 行业成分股

# 概念板块
ak.stock_board_concept_hist_em()  # 概念板块行情
```

**分析逻辑**:
1. **板块强度排名**
   - 近5日涨幅排名
   - 资金净流入排名
   - 领涨股数量

2. **轮动规律**
   - 牛市初期: 券商 → 地产 → 有色
   - 牛市中期: 科技 → 消费 → 医药
   - 牛市末期: 小盘题材股
   - 熊市: 防御性板块(公用事业/消费)

3. **热点持续性**
   - 连续流入N日 = 主线
   - 单日爆发 = 短期题材

---

### 功能6: 智能仓位管理 (Smart Position Management) ⭐⭐⭐⭐⭐

**目标**: 基于市场状态动态调整仓位

**策略矩阵**:

| 市场状态 | 估值分位 | 情绪阶段 | 主力行为 | 建议仓位 | 操作策略 |
|---------|---------|---------|---------|---------|---------|
| 牛市初期 | <30% | 谨慎 | 流入 | 80-90% | 积极做多 |
| 牛市中期 | 30-60% | 乐观 | 流入 | 70-80% | 持股为主 |
| 牛市末期 | >70% | 狂热 | 流出 | 30-50% | 逐步减仓 |
| 熊市初期 | >70% | 贪婪 | 流出 | 10-30% | 快速止损 |
| 熊市中期 | 40-70% | 谨慎 | 流出 | 20-30% | 等待企稳 |
| 熊市末期 | <30% | 恐慌 | 流入 | 40-60% | 分批建仓 |
| 震荡市 | 30-70% | 中性 | 中性 | 50-60% | 高抛低吸 |

**动态调整规则**:
```python
def calculate_smart_position(
    market_state: str,
    valuation_pct: float,
    sentiment_phase: str,
    main_fund_flow: float,
    confidence: float
) -> Dict:
    """
    智能仓位计算

    Returns:
        {
            'position': 0.75,  # 建议仓位75%
            'adjustment': +0.15,  # 相比当前仓位调整+15%
            'reason': '牛市中期+估值合理+主力流入',
            'stop_loss': 0.92,  # 止损线
            'take_profit': 1.15  # 止盈线
        }
    """
    pass
```

---

## 🚀 实施计划

### Phase 3.1: 市场状态诊断 (优先级P0)
**预计工期**: 1-2天

**实现步骤**:
1. ✅ 新增数据获取方法
   - 融资融券数据
   - 主力资金流向
   - 龙虎榜数据
   - 均线数据

2. ✅ 实现市场状态识别算法
   - 12维度评分模型
   - 状态分类器
   - 置信度计算

3. ✅ 更新demo脚本
   - 显示市场状态
   - 显示关键信号
   - 风险提示

**输出示例**:
```
【市场状态诊断】
  当前状态: 牛市中期 (置信度85%)

  关键信号:
    ✅ 趋势: 20/60/120日均线多头排列
    ✅ 资金: 主力连续5日净流入
    ⚠️  估值: PE分位65%,偏高
    ✅ 情绪: 乐观但未过热

  操作建议: 持股为主,逢低加仓
  建议仓位: 75% (+10%)
```

### Phase 3.2: 情绪周期追踪 (优先级P0)
**预计工期**: 1天

### Phase 3.3: 主力资金追踪 (优先级P1)
**预计工期**: 1天

### Phase 3.4: 行业轮动分析 (优先级P1)
**预计工期**: 2天

### Phase 3.5: 智能仓位管理 (优先级P0)
**预计工期**: 1天

---

## 📊 技术栈

**新增数据源 (AKShare)**:
- 融资融券: `stock_margin_*`
- 主力资金: `stock_main_fund_flow`
- 龙虎榜: `stock_lhb_*`
- 筹码分布: `stock_cyq_em`
- 行业板块: `stock_board_*`
- 大单追踪: `stock_fund_flow_big_deal`

**新增算法**:
- 状态机模型 (市场状态切换)
- 情绪周期模型 (快慢线系统)
- 轮动相关性分析 (板块联动)

**新增依赖**:
- 无 (使用现有库即可)

---

## 💡 创新点

1. **多维度融合**: 12维度 > 9维度,更全面
2. **状态识别**: 从"点位判断"到"状态诊断"的升级
3. **情绪量化**: 从静态指标到动态周期追踪
4. **智能决策**: 基于状态的自适应仓位管理
5. **可解释性**: 每个决策都有明确的依据和信号

---

## 🎯 与博主水平对比

| 维度 | 博主水平 | 当前Phase 2 | Phase 3目标 |
|------|---------|------------|-----------|
| 指标维度 | 9维 | 9维 ✅ | 12维+ ⬆️ |
| 市场状态 | 人工判断 | 无 | 自动识别 ⬆️ |
| 情绪周期 | 定性描述 | 无 | 量化追踪 ⬆️ |
| 主力资金 | 简单查看 | 北向资金 | 全方位追踪 ⬆️ |
| 行业轮动 | 经验判断 | 无 | 数据驱动 ⬆️ |
| 仓位管理 | 固定规则 | 简化Kelly | 动态智能 ⬆️ |

**目标**: Phase 3完成后,超越博主水平,达到**机构量化团队水平**!

---

## ⚠️ 注意事项

1. **数据质量**: AKShare部分接口可能不稳定,需要异常处理
2. **计算复杂度**: 12维度计算量大,需要优化性能
3. **过拟合风险**: 避免参数过度优化,保持鲁棒性
4. **实时性**: 部分数据有延迟,需要标注数据时间

---

**设计文档版本**: v1.0
**创建日期**: 2025-10-09
**状态**: 📋 待开发

**Made with ❤️ by Claude Code & Russ**
