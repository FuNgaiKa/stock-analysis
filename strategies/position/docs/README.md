# 历史点位对比分析系统

## 概述

基于历史数据统计，分析当前市场点位在历史上的相似时期，并通过概率模型预测后续走势，辅助投资决策和仓位管理。

## 🎉 最新更新 - Phase 3.1 市场状态智能诊断

**突破性升级**（2025-10-09）:
- 🚀 **12维度市场状态识别** - 自动诊断牛市/熊市/震荡市!
- 🚀 **智能评分模型** - 综合12个维度加权评分,精准判断市场方向
- 🚀 **状态置信度** - 量化判断的可靠程度
- 🚀 **关键信号提取** - 自动识别关键看多/看空信号
- 🚀 **风险预警** - 智能提示潜在风险点
- 🚀 **动态仓位建议** - 根据市场状态自适应调整仓位
- 🚀 **新增数据维度** - 均线、融资融券、主力资金、龙虎榜

**核心突破**: 从被动分析到主动诊断,从数据展示到智能决策!

详见:
- [Phase 3 设计文档](./PHASE3_DESIGN.md)
- [Phase 2 完整文档](./PHASE2_SUMMARY.md)
- [Phase 1.5 更新说明](./PHASE1.5_SUMMARY.md)

---

## 历史更新

### Phase 2: 九维度指标体系 ✅ 已完成
- ✅ **九维度市场分析** - 从4维扩展到9维，达到专业投资者水平
- ✅ **估值指标** - PE/PB历史分位数，判断市场贵贱
- ✅ **北向资金流向** - 追踪外资(聪明钱)动向
- ✅ **市场宽度指标** - 判断普涨/普跌/结构性行情
- ✅ **技术指标** - MACD/RSI趋势确认
- ✅ **波动率指标** - 风险水平量化
- ✅ **综合评分系统** - 多维度加权评分，智能仓位建议

---

## 核心功能

### ✅ Phase 1 基础功能

1. **单指数历史对比分析**
   - 查找历史相似点位（默认±5%区间）
   - 统计后续 5/10/20/60 日涨跌概率
   - 计算平均收益率、中位数、标准差等指标

2. **多指数联合匹配**
   - 同时分析多个指数的历史相似状态
   - 多维度匹配提高预测准确性

3. **概率统计模型**
   - 上涨/下跌概率计算
   - 置信度评估（基于样本量、一致性、时间分散度）
   - 年份分布统计

4. **仓位管理建议**
   - 基于概率和置信度的仓位建议
   - 交易信号分级（强买入/买入/中性/卖出/强卖出）
   - Kelly公式优化仓位配置

5. **双重报告输出**
   - **命令行文本报告**：详细的文字分析报告
   - **HTML可视化报告**：交互式图表（概率柱状图、置信度仪表盘等）

## 支持的标的

### 指数
- 上证指数 (sh000001)
- 沪深300 (sh000300)
- 创业板指 (sz399006)
- 科创50 (sh000688)
- 深证成指 (sz399001)
- 恒生科技 (hk_hstech)

### ETF（可自定义添加）
- 化工ETF (159870)
- 煤炭ETF (515220)
- 证券ETF (512880)
- 酒ETF (512690)

### 个股（可自定义添加）
- 三花智控 (002050)
- 其他个股...

💡 **添加新标的**: 编辑 `position_analysis/historical_position_analyzer.py` 中的 `SUPPORTED_INDICES` 字典即可

## 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖：
- pandas, numpy
- akshare (数据源)
- plotly (可视化)

## 快速开始

### 方式1：运行Phase 3市场状态诊断（最新推荐⭐⭐⭐）

```bash
# 快速市场状态诊断
python run_phase3_state_detection.py

# 分析指定指数
python run_phase3_state_detection.py --index sh000001  # 上证指数
python run_phase3_state_detection.py --index sz399006  # 创业板指

# 查看详细的12维度分析
python run_phase3_state_detection.py --detail
python run_phase3_state_detection.py -d  # 简写形式
```

**输出示例**:
```
【市场状态诊断】
  当前状态: 横盘震荡 (置信度 70%)
  状态描述: 多空平衡,方向不明
  综合评分: +0.19 / 1.00

【关键信号】
    ✅ 趋势强劲向上
    ✅ 市场情绪积极
    ✅ 技术形态良好

【风险警告】
    ⚠️  估值过高

【操作建议】
  建议仓位: 50% (45%-55%)
  操作策略: 观望为主
  具体行动: 等待方向

【12维度详细分析】 (--detail模式)
  1. 趋势(均线)       🟢 [████████████████████] +1.00 (权重15%)
  2. 涨跌幅          🟡 [█████░░░░░░░░░░░░░░░] +0.25 (权重10%)
  3. 估值           🔴 [░░░░░░░░░░██████████] -0.53 (权重12%)
  ...
```

### 方式2：运行Phase 2九维度分析

```bash
# 快速市场诊断
python run_phase2_analysis.py

# 分析指定指数
python run_phase2_analysis.py --index sh000001  # 上证指数
python run_phase2_analysis.py --index sz399006  # 创业板指

# 查看详细的历史匹配分析
python run_phase2_analysis.py --detail
```

**输出示例**:
```
【九维度市场扫描】
  ⚠️  估值: PE 78%, PB 75% → 高估值
  🟡 资金: 北向流入0亿 → 中性
  🟡 情绪: 涨停88只 → 高涨
  ⚠️  宽度: 上涨26.4% → 普跌
  ✅ 技术: MACD金叉 → 多头
  ✅ 波动: 12.3%分位19.5% → 极低波动
  ...

【综合诊断】
  综合评分: +0.01 / 1.00
  建议: 🟡 中性观望
  建议仓位: 40-50%
```

### 方式2：运行Phase 1.5增强版分析

**1.1 查看所有支持的标的**
```bash
python run_enhanced_analysis.py --list
```

**2.1 分析指定标的**
```bash
# 分析指数
python run_enhanced_analysis.py --code sh000001  # 上证指数
python run_enhanced_analysis.py --code sz399006  # 创业板指
python run_enhanced_analysis.py --code sh000688  # 科创50

# 分析ETF
python run_enhanced_analysis.py --code 512690    # 酒ETF
python run_enhanced_analysis.py --code 159870    # 化工ETF
python run_enhanced_analysis.py --code 512880    # 证券ETF

# 分析个股
python run_enhanced_analysis.py --code 002050    # 三花智控

# 简写形式
python run_enhanced_analysis.py -c 512690
```

**2.2 默认分析（不指定标的）**
```bash
python run_enhanced_analysis.py  # 默认分析科创50
```

**Phase 1.5 输出示例**:
```
当前酒ETF (etf): 0.58

=== 当前市场状态 ===
成交量状态: 正常水平
  当前成交量: 569.7亿
  量比: 0.98
市场情绪: 情绪高涨
  涨停: 88只

【基础匹配】仅价格（±5%）
  样本数: 183
  20日上涨概率: 51.4%

【增强匹配】价格+成交量
  样本数: 109
  20日上涨概率: 51.5%
  💡 调整: +0.0%

【分层统计】
放量突破（量比>1.5）: 上涨概率72.7%

建议仓位: 65%
```

### 方式3：运行Phase 1基础版分析

```bash
python run_position_analysis.py
```

### 方式4：添加自定义ETF/个股

编辑 `position_analysis/historical_position_analyzer.py` 文件：

```python
# 在 SUPPORTED_INDICES 字典中添加
SUPPORTED_INDICES = {
    # ... 现有配置 ...

    # 添加你想分析的ETF
    '159915': IndexConfig('159915', '创业板ETF', '159915', 'etf'),
    '510300': IndexConfig('510300', '沪深300ETF', '510300', 'etf'),
    '588000': IndexConfig('588000', '科创50ETF', '588000', 'etf'),

    # 添加你想分析的个股
    '600519': IndexConfig('600519', '贵州茅台', '600519', 'stock'),
    '000858': IndexConfig('000858', '五粮液', '000858', 'stock'),
}
```

保存后即可使用：
```bash
python run_enhanced_analysis.py --code 159915  # 分析创业板ETF
python run_enhanced_analysis.py --code 600519  # 分析贵州茅台
```

### 方式5：Python API调用

```python
from position_analysis import PositionAnalysisEngine

# 创建分析引擎（指定要分析的指数）
engine = PositionAnalysisEngine(
    indices=['sh000001', 'sh000300', 'sz399006']
)

# 执行分析
results = engine.run_full_analysis(
    tolerance=0.05,           # 相似度容差 ±5%
    periods=[5, 10, 20, 60],  # 预测周期
    output_html=True,         # 生成HTML报告
    output_dir='reports'      # 报告输出目录
)
```

## 输出示例

### 命令行文本报告

```
================================================================================
                        市场历史点位对比分析报告
分析时间: 2025-10-02 20:25:10
================================================================================

[当前市场点位]
  上证指数: 3882.78  (数据日期: 2025-09-30)
  沪深300: 4640.69  (数据日期: 2025-09-30)

[单指数历史对比分析]

【上证指数 - 3882.78】
历史相似点位出现: 127 次 (分布在 2007年(42次), 2015年(41次), 2025年(30次))

  未来20日涨跌概率:
    上涨概率: 50.9% (56次)
    下跌概率: 49.1% (54次)
    平均收益: +0.54%
    置信度: ★★★★☆ (71%)

[多指数联合分析]
找到 295 个历史时期，多个指数同时处于相似点位

多指数联合匹配后的未来20日走势:
  上涨概率: 49.1%
  下跌概率: 50.9%
  平均收益: -0.36%
  置信度: ★★★★☆

[仓位管理建议]
交易信号: 中性
建议仓位: 65%
策略说明: 中性：建议标准配置（65%左右）

[综合结论]
方向判断: 中性偏震荡 (置信度 72%)

主要依据:
  1. 历史相似点位样本共 563 个
  2. 历史数据显示，相似点位后涨跌概率相当(上涨52.5%)
  3. 多指数联合匹配找到 295 个时期

操作建议:
  短期(5-10日): 震荡为主，不追高不杀跌
  中期(20-60日): 保持中性仓位，等待方向明确
```

### HTML报告

生成交互式可视化报告，包含：
- 当前点位指标卡片
- 涨跌概率柱状图
- 置信度仪表盘
- 收益率分布图
- 历史时间线图

报告保存在 `reports/` 目录，用浏览器打开即可查看。

## 核心算法说明

### 1. 相似点位查找

```python
相似区间 = 当前价格 ± (当前价格 × tolerance)
```

### 2. 概率计算

```python
上涨概率 = 历史相似点位后上涨的次数 / 总样本数
平均收益 = mean(历史相似点位后的收益率)
```

### 3. 置信度计算

```python
置信度 = 0.5 × 样本量得分 + 0.3 × 一致性得分 + 0.2 × 时间分散度

样本量得分 = sigmoid(样本数)
一致性得分 = (max(上涨概率, 下跌概率) - 0.5) / 0.5
时间分散度 = min(1.0, 年份数 / 3)
```

### 4. 仓位建议（简化Kelly公式）

```python
Kelly仓位 = 期望收益 / 方差
最终仓位 = 0.7 × 基础仓位 + 0.3 × Kelly仓位
```

## 项目结构

```
position_analysis/
├── __init__.py                        # 包初始化
├── historical_position_analyzer.py    # 核心分析器
├── enhanced_data_provider.py          # 增强数据提供器（Phase 2/3）
├── market_state_detector.py           # 市场状态检测器（Phase 3.1新增）
├── report_generator.py                # 报告生成器
├── chart_generator.py                 # 图表生成器
├── main.py                            # 主程序入口
├── PHASE2_SUMMARY.md                  # Phase 2文档
└── PHASE3_DESIGN.md                   # Phase 3设计文档

run_position_analysis.py               # Phase 1快速启动脚本
run_enhanced_analysis.py               # Phase 1.5快速启动脚本
run_phase2_analysis.py                 # Phase 2快速启动脚本
run_phase3_state_detection.py          # Phase 3.1快速启动脚本（最新）
reports/                               # 报告输出目录
```

## 使用场景

1. **择时参考**：判断当前点位是否适合加仓/减仓
2. **风险评估**：了解当前点位的历史胜率和盈亏比
3. **仓位管理**：基于概率模型优化仓位配置
4. **策略回测**：验证历史相似情况的统计规律

## 重要说明

⚠️ **风险提示**

1. 历史统计不代表未来，市场环境会变化
2. 本工具仅供参考，不构成投资建议
3. 投资有风险，决策需谨慎，请结合基本面、政策面等多维度判断
4. 建议配合止损机制使用

## 开发路线图

### Phase 1: 基础功能 ✅ 已完成
- [x] 单/多指数历史点位查找
- [x] 概率统计模型
- [x] 仓位管理建议
- [x] HTML可视化报告

### Phase 1.5: 增强因子 ✅ 已完成
- [x] 成交量维度分析
- [x] 市场情绪指标
- [x] 量价背离检测
- [x] ETF和个股支持

### Phase 2: 九维度指标体系 ✅ 已完成
- [x] 估值指标（PE/PB分位数）
- [x] 北向资金流向
- [x] 市场宽度指标
- [x] 技术指标（MACD/RSI）
- [x] 波动率指标
- [x] 综合评分系统
- [x] 多维度匹配算法

### Phase 3.1: 市场状态智能诊断 ✅ 已完成
- [x] 均线数据获取（20/60/120日均线）
- [x] 融资融券指标（杠杆资金监测）
- [x] 主力资金流向（大单追踪）
- [x] 龙虎榜数据（机构行为）
- [x] 12维度评分模型
- [x] 市场状态自动识别（牛市/熊市/震荡市）
- [x] 关键信号提取与风险预警
- [x] 动态仓位建议系统

### Phase 3.2: 待开发功能
- [ ] 情绪周期追踪（快慢线双指标体系）
- [ ] 获取历史每日估值数据（完善估值过滤）
- [ ] 获取历史每日资金流向（完善资金过滤）
- [ ] 行业轮动分析
- [ ] 策略回测框架

### Phase 4: 高级功能
- [ ] K线形态对比可视化
- [ ] 相似度热力图
- [ ] 机器学习模型（随机森林、XGBoost）
- [ ] 策略回测与评估
- [ ] 在线学习与模型更新
- [ ] Web界面（Streamlit/Gradio）

## 技术栈

- **数据源**: AKShare (免费)
- **数据处理**: Pandas, NumPy
- **可视化**: Plotly
- **统计分析**: SciPy

## 贡献

欢迎提Issue和PR！

## License

MIT License

---

**Made with ❤️ by Claude Code & Russ**
