# 历史点位对比分析系统

## 概述

基于历史数据统计，分析当前市场点位在历史上的相似时期，并通过概率模型预测后续走势，辅助投资决策和仓位管理。

## 🎉 最新更新 - Phase 1.5 增强版

**新增功能**（2025-10-02）:
- ✅ **成交量匹配分析** - 价格+成交量双重过滤，更精准
- ✅ **市场情绪指标** - 涨跌停统计，情绪得分
- ✅ **量价背离检测** - 自动识别顶背离/底背离
- ✅ **分层概率统计** - 放量/缩量分别统计，不同情况不同概率

**实测效果**: 增强匹配使概率预测更准确，避免虚假相似！

详见: [Phase 1.5 更新说明](./PHASE1.5_SUMMARY.md)

---

## 核心功能

### ✅ Phase 1 基础功能

1. **单指数历史对比分析**
   - 查找历史相似点位（默认±5%区间）
   - 统计后续 5/10/20/60 日涨跌概率
   - 计算平均收益率、中位数、标准差等指标

2. **多指数联合匹配**
   - 同时分析多个指数的历史相似状态
   - 多维度匹配提高预测准确性

3. **概率统计模型**
   - 上涨/下跌概率计算
   - 置信度评估（基于样本量、一致性、时间分散度）
   - 年份分布统计

4. **仓位管理建议**
   - 基于概率和置信度的仓位建议
   - 交易信号分级（强买入/买入/中性/卖出/强卖出）
   - Kelly公式优化仓位配置

5. **双重报告输出**
   - **命令行文本报告**：详细的文字分析报告
   - **HTML可视化报告**：交互式图表（概率柱状图、置信度仪表盘等）

## 支持的指数

- 上证指数 (sh000001)
- 沪深300 (sh000300)
- 创业板指 (sz399006)
- 科创50 (sh000688)
- 深证成指 (sz399001)

## 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖：
- pandas, numpy
- akshare (数据源)
- plotly (可视化)

## 快速开始

### 方式1：运行增强版分析（推荐）

```bash
python run_enhanced_analysis.py
```

**输出示例**:
```
=== 当前市场状态 ===
成交量状态: 正常水平
  当前成交量: 569.7亿
  量比: 0.98
市场情绪: 情绪高涨
  涨停: 52只

【基础匹配】仅价格（±5%）
  样本数: 127
  20日上涨概率: 50.9%

【增强匹配】价格+成交量
  样本数: 92
  20日上涨概率: 44.7%
  💡 调整: -6.2% (更谨慎)

【分层统计】
缩量上涨: 上涨概率73.9%

建议仓位: 50%
```

### 方式2：运行基础版分析

```bash
python run_position_analysis.py
```

### 方式3：自定义参数

```python
from position_analysis import PositionAnalysisEngine

# 创建分析引擎（指定要分析的指数）
engine = PositionAnalysisEngine(
    indices=['sh000001', 'sh000300', 'sz399006']
)

# 执行分析
results = engine.run_full_analysis(
    tolerance=0.05,           # 相似度容差 ±5%
    periods=[5, 10, 20, 60],  # 预测周期
    output_html=True,         # 生成HTML报告
    output_dir='reports'      # 报告输出目录
)
```

## 输出示例

### 命令行文本报告

```
================================================================================
                        市场历史点位对比分析报告
分析时间: 2025-10-02 20:25:10
================================================================================

[当前市场点位]
  上证指数: 3882.78  (数据日期: 2025-09-30)
  沪深300: 4640.69  (数据日期: 2025-09-30)

[单指数历史对比分析]

【上证指数 - 3882.78】
历史相似点位出现: 127 次 (分布在 2007年(42次), 2015年(41次), 2025年(30次))

  未来20日涨跌概率:
    上涨概率: 50.9% (56次)
    下跌概率: 49.1% (54次)
    平均收益: +0.54%
    置信度: ★★★★☆ (71%)

[多指数联合分析]
找到 295 个历史时期，多个指数同时处于相似点位

多指数联合匹配后的未来20日走势:
  上涨概率: 49.1%
  下跌概率: 50.9%
  平均收益: -0.36%
  置信度: ★★★★☆

[仓位管理建议]
交易信号: 中性
建议仓位: 65%
策略说明: 中性：建议标准配置（65%左右）

[综合结论]
方向判断: 中性偏震荡 (置信度 72%)

主要依据:
  1. 历史相似点位样本共 563 个
  2. 历史数据显示，相似点位后涨跌概率相当(上涨52.5%)
  3. 多指数联合匹配找到 295 个时期

操作建议:
  短期(5-10日): 震荡为主，不追高不杀跌
  中期(20-60日): 保持中性仓位，等待方向明确
```

### HTML报告

生成交互式可视化报告，包含：
- 当前点位指标卡片
- 涨跌概率柱状图
- 置信度仪表盘
- 收益率分布图
- 历史时间线图

报告保存在 `reports/` 目录，用浏览器打开即可查看。

## 核心算法说明

### 1. 相似点位查找

```python
相似区间 = 当前价格 ± (当前价格 × tolerance)
```

### 2. 概率计算

```python
上涨概率 = 历史相似点位后上涨的次数 / 总样本数
平均收益 = mean(历史相似点位后的收益率)
```

### 3. 置信度计算

```python
置信度 = 0.5 × 样本量得分 + 0.3 × 一致性得分 + 0.2 × 时间分散度

样本量得分 = sigmoid(样本数)
一致性得分 = (max(上涨概率, 下跌概率) - 0.5) / 0.5
时间分散度 = min(1.0, 年份数 / 3)
```

### 4. 仓位建议（简化Kelly公式）

```python
Kelly仓位 = 期望收益 / 方差
最终仓位 = 0.7 × 基础仓位 + 0.3 × Kelly仓位
```

## 项目结构

```
position_analysis/
├── __init__.py                        # 包初始化
├── historical_position_analyzer.py    # 核心分析器
├── report_generator.py                # 报告生成器
├── chart_generator.py                 # 图表生成器
└── main.py                            # 主程序入口

run_position_analysis.py               # 快速启动脚本
reports/                               # 报告输出目录
```

## 使用场景

1. **择时参考**：判断当前点位是否适合加仓/减仓
2. **风险评估**：了解当前点位的历史胜率和盈亏比
3. **仓位管理**：基于概率模型优化仓位配置
4. **策略回测**：验证历史相似情况的统计规律

## 重要说明

⚠️ **风险提示**

1. 历史统计不代表未来，市场环境会变化
2. 本工具仅供参考，不构成投资建议
3. 投资有风险，决策需谨慎，请结合基本面、政策面等多维度判断
4. 建议配合止损机制使用

## 下一步计划 (Phase 2/3)

### Phase 2: 增强因子
- [ ] 成交量维度分析
- [ ] 估值指标（PE/PB分位数）
- [ ] 市场情绪指标（涨跌停、北向资金）
- [ ] 技术形态识别（均线、MACD）

### Phase 3: 高级功能
- [ ] K线形态对比可视化
- [ ] 相似度热力图
- [ ] 机器学习模型（随机森林、XGBoost）
- [ ] 策略回测与评估
- [ ] 在线学习与模型更新

## 技术栈

- **数据源**: AKShare (免费)
- **数据处理**: Pandas, NumPy
- **可视化**: Plotly
- **统计分析**: SciPy

## 贡献

欢迎提Issue和PR！

## License

MIT License

---

**Made with ❤️ by Claude Code & Russ**
